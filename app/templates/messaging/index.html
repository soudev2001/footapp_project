{% extends "base.html" %}
{% block title %}Messages - FootLogic{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-5rem)] -mt-20 pt-20 overflow-hidden bg-[#0f172a]">
    <!-- Chat Sidebar -->
    <aside class="w-full md:w-80 lg:w-96 glass-dark border-r border-white/5 flex flex-col z-20" id="chatSidebar">
        <!-- Header -->
        <div class="p-6 border-b border-white/5">
            <h2 class="text-xl font-black tracking-tight text-white mb-4">
                MESSAGES <span class="text-primary-500">.</span>
            </h2>
            <div class="relative group">
                <i
                    class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-white/20 group-focus-within:text-primary-500 transition-colors"></i>
                <input type="text" id="userSearch" placeholder="Rechercher une conversation..."
                    class="w-full bg-white/5 border border-white/5 rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-white/20 focus:outline-none focus:border-primary-500/50 focus:bg-white/10 transition-all"
                    onkeyup="filterConversations()">
            </div>
        </div>

        <!-- Conversations List -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">

            <!-- Teams Section -->
            {% if teams %}
            <div>
                <h3 class="text-[10px] font-bold uppercase tracking-widest text-white/20 px-2 mb-3">Équipes</h3>
                <div class="space-y-1">
                    {% for team in teams %}
                    <button onclick="loadChat('team', '{{ team._id|string }}', '{{ team.name }}')"
                        class="chat-item w-full flex items-center gap-4 p-3 rounded-2xl hover:bg-white/5 transition-all text-left group border border-transparent hover:border-white/5 relative overflow-hidden"
                        data-name="{{ team.name|lower }}" data-type="team" data-id="{{ team._id }}">

                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg group-hover:scale-105 transition-transform duration-300">
                            <i class="fa-solid fa-people-group text-sm"></i>
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-0.5">
                                <p
                                    class="text-sm font-bold text-white group-hover:text-primary-400 transition-colors truncate">
                                    {{ team.name }}</p>
                                <span class="text-[10px] text-white/20">--:--</span>
                            </div>
                            <p class="text-xs text-white/40 truncate group-hover:text-white/60 transition-colors">
                                Discussion d'équipe</p>
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Direct Messages Section -->
            {% if members %}
            <div>
                <h3 class="text-[10px] font-bold uppercase tracking-widest text-white/20 px-2 mb-3">Direct</h3>
                <div class="space-y-1">
                    {% for member in members if member._id|string != current_user.id %}
                    <button
                        onclick="loadChat('direct', '{{ member._id|string }}', '{{ member.profile.first_name }} {{ member.profile.last_name }}')"
                        class="chat-item w-full flex items-center gap-4 p-3 rounded-2xl hover:bg-white/5 transition-all text-left group border border-transparent hover:border-white/5 relative overflow-hidden"
                        data-name="{{ member.profile.first_name|lower }} {{ member.profile.last_name|lower }}"
                        data-type="direct" data-id="{{ member._id }}">

                        <div
                            class="w-12 h-12 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-bold text-sm shadow-inner group-hover:border-primary-500/30 transition-colors">
                            {{ member.profile.first_name[:1] }}{{ member.profile.last_name[:1] }}
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-0.5">
                                <p
                                    class="text-sm font-bold text-white group-hover:text-primary-400 transition-colors truncate">
                                    {{ member.profile.first_name }} {{ member.profile.last_name }}
                                </p>
                                <span class="text-[10px] text-white/20">--:--</span>
                            </div>
                            <p
                                class="text-xs text-white/40 truncate group-hover:text-white/60 transition-colors capitalize">
                                {{ member.role }}</p>
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </aside>

    <!-- Chat Main Area -->
    <main class="flex-1 flex flex-col relative w-full bg-[#0b1121]" id="chatMain">
        <!-- Initial State -->
        <div id="noChatState" class="absolute inset-0 flex flex-col items-center justify-center z-10">
            <div
                class="w-24 h-24 rounded-[32px] bg-white/5 border border-white/10 flex items-center justify-center mb-8 animate-pulse">
                <i class="fa-solid fa-comments text-4xl text-white/20"></i>
            </div>
            <h3 class="text-2xl font-black text-white mb-2 uppercase tracking-tight">FootLogic Chat</h3>
            <p class="text-white/30 text-sm max-w-xs text-center">Sélectionnez une conversation pour commencer à
                échanger avec votre équipe.</p>
        </div>

        <!-- Active Chat -->
        <div id="activeChat" class="flex flex-col h-full hidden opacity-0 transition-opacity duration-500">
            <!-- Header -->
            <div
                class="h-20 border-b border-white/5 px-8 flex items-center justify-between bg-[#0f172a]/80 backdrop-blur-md z-10">
                <div class="flex items-center gap-5">
                    <button class="md:hidden text-white/50 hover:text-white" onclick="toggleSidebar()">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div id="activeChatAvatar"
                        class="w-10 h-10 rounded-xl gradient-primary flex items-center justify-center text-sm font-bold text-white shadow-lg shadow-primary-500/20">
                        ?
                    </div>
                    <div>
                        <h3 id="activeChatName" class="text-base font-bold text-white leading-tight">...</h3>
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                            <p id="activeChatStatus"
                                class="text-[10px] text-white/40 font-bold uppercase tracking-wider">En ligne</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button
                        class="w-10 h-10 rounded-xl hover:bg-white/5 text-white/20 hover:text-white transition flex items-center justify-center">
                        <i class="fa-solid fa-phone"></i>
                    </button>
                    <button
                        class="w-10 h-10 rounded-xl hover:bg-white/5 text-white/20 hover:text-white transition flex items-center justify-center">
                        <i class="fa-solid fa-video"></i>
                    </button>
                    <button
                        class="w-10 h-10 rounded-xl hover:bg-white/5 text-white/20 hover:text-white transition flex items-center justify-center">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar scroll-smooth relative">
                <!-- Messages will be injected here -->
            </div>

            <!-- Input Area -->
            <div class="p-6 bg-[#0f172a] border-t border-white/5">
                <div class="relative flex items-end gap-4 max-w-5xl mx-auto">
                    <button
                        class="w-12 h-12 rounded-2xl bg-white/5 border border-white/5 text-white/30 hover:text-white hover:bg-white/10 transition flex-shrink-0 flex items-center justify-center">
                        <i class="fa-solid fa-plus text-lg"></i>
                    </button>
                    <div class="flex-1 relative">
                        <textarea id="messageInput" rows="1" placeholder="Écrivez votre message..."
                            class="w-full bg-white/5 border border-white/10 rounded-2xl py-3.5 pl-6 pr-14 text-sm text-white placeholder-white/20 focus:outline-none focus:border-primary-500/50 focus:bg-white/10 transition-all resize-none custom-scrollbar"
                            style="min-height: 50px; max-height: 150px;"></textarea>
                        <button onclick="sendMessage()" id="sendBtn"
                            class="absolute right-2 bottom-2 w-10 h-9 rounded-xl gradient-primary flex items-center justify-center text-white shadow-lg hover:shadow-primary-500/20 hover:scale-105 active:scale-95 transition-all">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
                <p class="text-center text-[10px] text-white/10 mt-3 font-medium">Appuyez sur Entrée pour envoyer</p>
            </div>
        </div>
    </main>
</div>

<template id="messageTemplate">
    <div class="message-row flex w-full mb-6">
        <div class="message-content flex flex-col max-w-[75%] md:max-w-[60%]">
            <span class="sender-name text-[10px] text-white/30 ml-3 mb-1 font-bold hidden"></span>
            <div
                class="message-bubble px-5 py-3 rounded-[20px] text-sm leading-relaxed shadow-sm break-words relative group">
                <p class="text-content"></p>
                <span
                    class="time-read absolute bottom-1 right-3 text-[9px] opacity-0 group-hover:opacity-60 transition-opacity font-medium"></span>
            </div>
        </div>
    </div>
</template>

<script>
    let currentChat = {
        type: null,
        id: null,
        name: null
    };
    let pollingInterval = null;
    let lastMessageId = null;

    // Auto-resize textarea
    const tx = document.getElementById('messageInput');
    tx.setAttribute('style', 'height:' + (tx.scrollHeight) + 'px;overflow-y:hidden;');
    tx.addEventListener("input", OnInput, false);
    function OnInput() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.value === '') this.style.height = '50px';
    }

    // Toggle Sidebar on mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('chatSidebar');
        sidebar.classList.toggle('hidden');
        sidebar.classList.toggle('absolute');
        sidebar.classList.toggle('inset-0');
    }

    function filterConversations() {
        const query = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('.chat-item').forEach(item => {
            const name = item.getAttribute('data-name');
            item.style.display = name.includes(query) ? 'flex' : 'none';
        });
    }

    async function loadChat(type, id, name) {
        // Debounce if clicking same chat
        if (currentChat.id === id && currentChat.type === type) return;

        currentChat = { type, id, name };
        lastMessageId = null;

        // UI Updates
        document.querySelectorAll('.chat-item').forEach(b => {
            b.classList.remove('bg-white/10', 'border-primary-500/30');
            if (b.getAttribute('data-id') === id) {
                b.classList.add('bg-white/10', 'border-primary-500/30');
            }
        });

        const activeChat = document.getElementById('activeChat');
        const noChat = document.getElementById('noChatState');

        noChat.style.display = 'none';
        activeChat.classList.remove('hidden');
        // Trigger reflow/animation
        setTimeout(() => activeChat.classList.remove('opacity-0'), 10);

        document.getElementById('activeChatName').innerText = name;
        document.getElementById('activeChatAvatar').innerText = name.charAt(0).toUpperCase();

        // Clear messages
        document.getElementById('chatMessages').innerHTML = '<div class="flex items-center justify-center h-full"><i class="fa-solid fa-spinner fa-spin text-white/20 text-2xl"></i></div>';

        // Stop previous polling
        if (pollingInterval) clearInterval(pollingInterval);

        await fetchMessages();

        // Start polling
        pollingInterval = setInterval(fetchMessages, 5000);

        // Sidebar mobile logic
        if (window.innerWidth < 768) {
            document.getElementById('chatSidebar').classList.add('hidden');
        }
    }

    async function fetchMessages() {
        if (!currentChat.id) return;

        const endpoint = currentChat.type === 'team' ? `/messages/history/team/${currentChat.id}` : `/messages/history/direct/${currentChat.id}`;

        try {
            const response = await fetch(endpoint);
            const data = await response.json();
            renderMessages(data.history);
        } catch (err) {
            console.error('Failed to sync messages:', err);
        }
    }

    function renderMessages(history) {
        const container = document.getElementById('chatMessages');
        // Only clear if loading first time (spinner present) or significant refresh strategy (MVP: clear all is safer to avoid dupes without complex differential logic)
        // Ideally: check last ID and append only new ones. For now, simple re-render but preserve scroll if near bottom.

        const wasAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

        // For smoother UX, we might want to diff. But let's just re-render cleanly.
        container.innerHTML = '';

        if (history.length === 0) {
            container.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center text-center opacity-30 mt-20">
                     <div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center mb-4">
                        <i class="fa-solid fa-comment-dots text-2xl"></i>
                    </div>
                    <p class="text-sm font-medium">Démarrez la conversation !</p>
                    <p class="text-xs mt-1">Envoyez un message pour briser la glace.</p>
                </div>
            `;
            return;
        }

        const template = document.getElementById('messageTemplate');
        let lastSenderId = null;

        history.forEach(msg => {
            const isMe = msg.sender_id === '{{ current_user.id }}';
            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('.message-row');
            const bubble = clone.querySelector('.message-bubble');
            const content = clone.querySelector('.text-content');
            const sender = clone.querySelector('.sender-name');
            const time = clone.querySelector('.time-read');

            // Alignment
            if (isMe) {
                row.classList.add('justify-end');
                bubble.classList.add('gradient-primary', 'text-white', 'rounded-tr-sm');
            } else {
                row.classList.add('justify-start');
                bubble.classList.add('bg-[#1e293b]', 'text-white/90', 'border', 'border-white/5', 'rounded-tl-sm');
            }

            // Sender Name (in team chat, if changed sender)
            if (!isMe && currentChat.type === 'team' && msg.sender_id !== lastSenderId) {
                sender.innerText = msg.sender_name;
                sender.classList.remove('hidden');
            }
            lastSenderId = msg.sender_id;

            // Content
            content.innerText = msg.content;

            // Time (format ISO to HH:MM)
            const date = new Date(msg.created_at);
            time.innerText = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Styling tweak for consecutive messages
            if (isMe) {
                bubble.style.boxShadow = '0 4px 15px rgba(37, 99, 235, 0.1)';
            }

            container.appendChild(clone);
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();
        const btn = document.getElementById('sendBtn');

        if (!content || !currentChat.id) return;

        input.disabled = true;
        btn.disabled = true;

        const payload = {
            content: content,
            type: currentChat.type
        };

        if (currentChat.type === 'team') payload.team_id = currentChat.id;
        else payload.receiver_id = currentChat.id;

        try {
            const response = await fetch('/messages/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                input.value = '';
                input.style.height = '50px'; // Reset height
                await fetchMessages(); // Immediate refresh
            }
        } catch (err) {
            console.error('Failed to send message:', err);
            alert('Erreur lors de l\'envoi');
        } finally {
            input.disabled = false;
            btn.disabled = false;
            input.focus();
        }
    }

    // Enter key to send (Shift+Enter for new line)
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>

<style>
    /* Styling scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    #chatMain {
        background-image:
            radial-gradient(circle at 50% 0%, rgba(37, 99, 235, 0.03) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.03) 0%, transparent 40%);
    }

    .glass-dark {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(12px);
    }
</style>
{% endblock %}