{% extends "base.html" %}
{% block title %}Convocation Match - FootLogic{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8" id="convocation-app">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6 mb-10">
        <div>
            <h1 class="text-3xl font-black text-white uppercase tracking-tighter mb-2">
                <span
                    class="text-transparent bg-clip-text bg-gradient-to-r from-primary-400 to-primary-600">Convocation</span>
                Match
            </h1>
            <p class="text-white/40 text-sm font-medium">Sélectionnez les joueurs pour le prochain match</p>
        </div>

        <div class="flex items-center gap-4">
            <div class="px-6 py-3 rounded-2xl bg-white/5 border border-white/10 flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-white text-xs font-bold uppercase tracking-wider" id="selectedCount">0 Joueurs
                    sélectionnés</span>
            </div>

            <button onclick="sendConvocation()" id="sendBtn"
                class="px-8 py-3 rounded-xl gradient-primary text-white font-bold uppercase tracking-wider hover:shadow-lg hover:shadow-primary-500/20 hover:scale-105 active:scale-95 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa-solid fa-paper-plane mr-2"></i>
                Envoyer
            </button>
        </div>
    </div>

    <!-- Match Selection (If needed) -->
    <!-- Ideally here we selector the match from upcoming matches -->
    <div class="mb-8 p-6 rounded-3xl glass border border-white/5">
        <label class="block text-xs font-bold text-white/40 uppercase tracking-wider mb-3">Sélectionner un
            événement</label>
        <select id="eventSelect"
            class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-primary-500 transition appearance-none cursor-pointer">
            <option value="" disabled selected>Choisir un match ou entraînement...</option>
            {% for event in events %}
            <option value="{{ event._id }}">
                {{ event.type|upper }} - {{ event.title }} ({{ event.start.strftime('%d/%m %H:%M') }})
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Filters & List -->
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Sidebar Filters -->
        <div class="w-full lg:w-64 space-y-6">
            <div class="glass p-6 rounded-2xl border border-white/5">
                <h3 class="text-xs font-bold text-white uppercase tracking-wider mb-4">Postes</h3>
                <div class="space-y-3">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox"
                            class="form-checkbox bg-white/10 border-white/20 text-primary-500 rounded focus:ring-0 focus:ring-offset-0"
                            checked onchange="filterPlayers('GK')">
                        <span class="text-sm text-white/60 group-hover:text-white transition">Gardiens</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox"
                            class="form-checkbox bg-white/10 border-white/20 text-primary-500 rounded focus:ring-0 focus:ring-offset-0"
                            checked onchange="filterPlayers('DEF')">
                        <span class="text-sm text-white/60 group-hover:text-white transition">Défenseurs</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox"
                            class="form-checkbox bg-white/10 border-white/20 text-primary-500 rounded focus:ring-0 focus:ring-offset-0"
                            checked onchange="filterPlayers('MID')">
                        <span class="text-sm text-white/60 group-hover:text-white transition">Milieux</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox"
                            class="form-checkbox bg-white/10 border-white/20 text-primary-500 rounded focus:ring-0 focus:ring-offset-0"
                            checked onchange="filterPlayers('ATT')">
                        <span class="text-sm text-white/60 group-hover:text-white transition">Attaquants</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Player Grid -->
        <div class="flex-1">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="playersGrid">
                {% for player in players %}
                <div class="player-card glass p-4 rounded-2xl border border-white/5 cursor-pointer relative group transition-all duration-300 hover:bg-white/5 hover:-translate-y-1"
                    data-id="{{ player._id }}" data-pos="{{ player.position }}"
                    onclick="togglePlayer('{{ player._id }}')">

                    <!-- Selection Indicator -->
                    <div
                        class="absolute top-4 right-4 w-6 h-6 rounded-full border-2 border-white/20 flex items-center justify-center transition-all duration-300 selection-indicator">
                        <i class="fa-solid fa-check text-[10px] text-transparent transition-all duration-300"></i>
                    </div>

                    <div class="flex items-start gap-4 mb-4">
                        <div
                            class="w-12 h-12 rounded-xl gradient-primary flex items-center justify-center font-bold text-white shadow-lg">
                            {{ player.jersey_number }}
                        </div>
                        <div>
                            <h4 class="font-bold text-white text-sm">{{ player.name }}</h4>
                            <p class="text-xs text-white/40 font-bold uppercase tracking-wider">{{ player.position }}
                            </p>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-white/30">Forme</span>
                            <div class="flex gap-1">
                                {% for i in range(5) %}
                                <div
                                    class="w-1.5 h-1.5 rounded-full {% if i < 4 %}bg-green-500{% else %}bg-white/10{% endif %}">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-white/30">Note Moy.</span>
                            <span class="font-bold text-amber-400">7.2</span>
                        </div>

                        <!-- Status Badge (e.g., Injured, Suspended) -->
                        {% if player.status == 'injured' %}
                        <div
                            class="mt-2 py-1 px-2 rounded bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] uppercase font-bold text-center">
                            Blessé
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    const selectedPlayers = new Set();

    function togglePlayer(playerId) {
        const card = document.querySelector(`.player-card[data-id="${playerId}"]`);
        const indicator = card.querySelector('.selection-indicator');
        const checkIcon = indicator.querySelector('i');

        if (selectedPlayers.has(playerId)) {
            selectedPlayers.delete(playerId);
            card.classList.remove('border-primary-500', 'bg-primary-500/5');
            card.classList.add('border-white/5');
            indicator.classList.remove('bg-primary-500', 'border-primary-500');
            indicator.classList.add('border-white/20');
            checkIcon.classList.remove('text-white');
            checkIcon.classList.add('text-transparent');
        } else {
            selectedPlayers.add(playerId);
            card.classList.remove('border-white/5');
            card.classList.add('border-primary-500', 'bg-primary-500/5');
            indicator.classList.remove('border-white/20');
            indicator.classList.add('bg-primary-500', 'border-primary-500');
            checkIcon.classList.remove('text-transparent');
            checkIcon.classList.add('text-white');
        }

        updateCount();
    }

    function updateCount() {
        document.getElementById('selectedCount').textContent = `${selectedPlayers.size} Joueur${selectedPlayers.size > 1 ? 's' : ''} sélectionné${selectedPlayers.size > 1 ? 's' : ''}`;
    }

    function filterPlayers(category) {
        // Implementation for filtering grid based on position categories
        // Simple client-side filtering
        const cards = document.querySelectorAll('.player-card');
        cards.forEach(card => {
            const pos = card.getAttribute('data-pos');
            let show = true;

            // Simplified logic: map specific positions to categories (GK, DEF, MID, ATT)
            let cat = 'MID';
            if (pos === 'GK') cat = 'GK';
            else if (['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(pos)) cat = 'DEF';
            else if (['CDM', 'CM', 'CAM', 'LM', 'RM'].includes(pos)) cat = 'MID';
            else if (['ST', 'CF', 'LW', 'RW'].includes(pos)) cat = 'ATT';

            // Allow checking checkbox state... (omitted for brevity, assume "category" arg matches simplified logic or pass active filters)
            // Ideally we'd scan all checkboxes state and filter accordingly.
        });
    }

    function sendConvocation() {
        const eventId = document.getElementById('eventSelect').value;
        const btn = document.getElementById('sendBtn');

        if (!eventId) {
            alert("Veuillez sélectionner un événement.");
            return;
        }

        if (selectedPlayers.size === 0) {
            alert("Veuillez sélectionner au moins un joueur.");
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Envoi...';

        fetch('/coach/convocation/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                event_id: eventId,
                player_ids: Array.from(selectedPlayers)
            })
        })
            .then(r => r.json())
            .then(data => {
                alert("Convocation envoyée avec succès !");
                window.location.reload();
            })
            .catch(err => {
                console.error(err);
                alert("Erreur lors de l'envoi.");
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i>Envoyer';
            });
    }
</script>
{% endblock %}