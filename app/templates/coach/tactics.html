{% extends "base.html" %}
{% block title %}Tactique Elite - FootLogic{% endblock %}

{% block content %}
<div class="lg:h-[calc(100vh-100px)] h-auto flex flex-col lg:flex-row gap-6 p-6 page-enter overflow-y-auto lg:overflow-hidden"
    id="tactics-config" data-starters='{{ (lineup.starters or {}) | tojson | safe }}'
    data-substitutes='{{ (lineup.substitutes or []) | tojson | safe }}'
    data-formation="{{ lineup.formation or '4-3-3' }}"
    data-tactical-config='{{ (lineup.tactical_config or {}) | tojson | safe }}'
    data-captains='{{ (lineup.captains or []) | tojson | safe }}'
    data-set-pieces='{{ (lineup.set_pieces or {}) | tojson | safe }}'>

    <!-- Sidebar / Players List -->
    <div class="w-full lg:w-96 flex flex-col gap-6">
        <div class="glass p-6 rounded-3xl border-white/5 flex-1 flex flex-col overflow-hidden">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="font-bold text-slate-900 dark:text-white uppercase text-sm tracking-wider">Effectif
                        √âquipe</h2>
                    {% if teams %}
                    <form id="teamFilterForm" method="GET" action="{{ url_for('coach.tactics') }}" class="mt-4">
                        <select name="team_id" onchange="this.form.submit()"
                            class="w-full bg-slate-50 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl py-2 px-4 text-slate-900 dark:text-white text-[10px] font-bold uppercase tracking-wider focus:outline-none focus:border-primary-500 appearance-none cursor-pointer transition-all">
                            {% for team in teams %}
                            <option value="{{ team._id|string }}" {% if selected_team_id==team._id|string %}selected{%
                                endif %} class="bg-slate-900">
                                {{ team.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                    {% endif %}
                </div>
            </div>

            <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar" id="availablePlayers">
                {% for player in players %}
                {% set stats = player.get('technical_ratings', {}) %}
                {% set ovr = ((stats.get('VIT', 50) + stats.get('TIR', 50) + stats.get('PAS', 50) + stats.get('DRI', 50)
                + stats.get('DEF', 50) + stats.get('PHY', 50)) / 6) | round | int %}
                <div draggable="true"
                    class="relative p-3 rounded-xl bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-white/10 flex items-center justify-between group hover:border-amber-500/50 hover:shadow-[0_0_15px_rgba(245,158,11,0.15)] transition-all duration-300 cursor-grab active:cursor-grabbing player-card overflow-hidden shadow-sm dark:shadow-none"
                    data-player-id="{{ player._id }}" data-player-name="{{ player.name }}"
                    data-player-number="{{ player.jersey_number or '?' }}" data-player-pos="{{ player.position }}"
                    data-player-vit="{{ stats.get('VIT', 50) }}" data-player-tir="{{ stats.get('TIR', 50) }}"
                    data-player-pas="{{ stats.get('PAS', 50) }}" data-player-dri="{{ stats.get('DRI', 50) }}"
                    data-player-def="{{ stats.get('DEF', 50) }}" data-player-phy="{{ stats.get('PHY', 50) }}"
                    data-overall="{{ ovr }}" onclick="selectPlayerCard(this)" ondragstart="onDragStart(event, this)"
                    ondragend="onDragEnd(event)">

                    <!-- Card Background Effect -->
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>

                    <div class="flex items-center gap-4 relative z-10">
                        <!-- Rating Badge -->
                        <div
                            class="w-10 h-10 flex flex-col items-center justify-center rounded bg-gradient-to-b from-[#fcd34d] to-[#d97706] text-black shadow-lg border-b-2 border-[#92400e]">
                            <span class="text-sm font-[900] leading-none">{{ ovr }}</span>
                            <span class="text-[8px] font-bold uppercase leading-none mt-0.5">{{ player.position
                                }}</span>
                        </div>

                        <!-- Info -->
                        <div>
                            <p
                                class="text-sm font-bold text-slate-900 dark:text-white group-hover:text-amber-500 dark:group-hover:text-amber-400 transition-colors">
                                {{
                                player.name }}</p>
                            <div
                                class="flex items-center gap-2 text-[10px] text-slate-500 dark:text-white/40 font-bold">
                                <span>#{{ player.jersey_number or '?' }}</span>
                                <span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-white/20"></span>
                                <span>{{ stats.get('VIT', 50) }} VIT</span>
                            </div>
                        </div>
                    </div>

                    <!-- Grab Handle -->
                    <div
                        class="w-6 h-6 rounded-full bg-slate-100 dark:bg-white/5 flex items-center justify-center text-slate-300 dark:text-white/10 group-hover:text-amber-400 group-hover:bg-amber-500/10 transition-colors">
                        <i class="fa-solid fa-grip-vertical text-xs"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div
            class="glass p-8 rounded-3xl border-slate-200 dark:border-white/5 bg-gradient-to-br from-primary-500/5 dark:from-primary-500/10 to-transparent">

            <div class="mb-8">
                <h3 class="font-bold text-slate-900 dark:text-white text-xs uppercase tracking-wider mb-4">Nom de la
                    tactique</h3>
                <div class="relative group">
                    <input type="text" id="tacticNameInput" placeholder="Sans titre (auto-save)"
                        value="{{ lineup.name or '' }}" oninput="triggerAutoSave()"
                        class="w-full bg-slate-50 dark:bg-surface-950 border border-slate-200 dark:border-white/10 py-4 px-6 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-primary-500 transition text-slate-900 dark:text-white">
                    <div id="autoSaveStatus"
                        class="absolute -bottom-6 right-2 text-[9px] font-bold uppercase tracking-widest transition-all">
                    </div>
                </div>
            </div>

            <h3 class="font-bold text-slate-900 dark:text-white text-xs uppercase tracking-wider mb-6">Configuration
                Syst√®me</h3>
            <div class="relative group">
                <select id="formationSelect" onchange="updateFormation()"
                    class="w-full bg-slate-50 dark:bg-surface-950 border border-slate-200 dark:border-white/10 py-4 px-6 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-primary-500 transition appearance-none cursor-pointer text-slate-900 dark:text-white">
                    <!-- Formations √âquilibr√©es -->
                    <optgroup label="‚öñÔ∏è  √âQUILIBR√âES">
                        <option value="4-3-3" {% if lineup.formation=='4-3-3' %}selected{% endif %}>4 - 3 - 3 ATTAQUE
                        </option>
                        <option value="4-4-2" {% if lineup.formation=='4-4-2' %}selected{% endif %}>4 - 4 - 2 CLASSIQUE
                        </option>
                        <option value="4-2-3-1" {% if lineup.formation=='4-2-3-1' %}selected{% endif %}>4 - 2 - 3 - 1
                            MODERNE</option>
                        <option value="4-5-1" {% if lineup.formation=='4-5-1' %}selected{% endif %}>4 - 5 - 1 POSSESSION
                        </option>
                    </optgroup>

                    <!-- Formations D√©fensives -->
                    <optgroup label="üõ°Ô∏è  D√âFENSIVES">
                        <option value="3-5-2" {% if lineup.formation=='3-5-2' %}selected{% endif %}>3 - 5 - 2 DYNAMIQUE
                        </option>
                        <option value="5-3-2" {% if lineup.formation=='5-3-2' %}selected{% endif %}>5 - 3 - 2 TR√àS
                            D√âFENSIF</option>
                        <option value="5-4-1" {% if lineup.formation=='5-4-1' %}selected{% endif %}>5 - 4 - 1 ULTRA
                            D√âFENSIF</option>
                    </optgroup>

                    <!-- Formations Offensives -->
                    <optgroup label="‚ö° OFFENSIVES">
                        <option value="4-1-2-1-2" {% if lineup.formation=='4-1-2-1-2' %}selected{% endif %}>4 - 1 - 2 -
                            1 - 2 DIAMANT</option>
                        <option value="4-3-2-1" {% if lineup.formation=='4-3-2-1' %}selected{% endif %}>4 - 3 - 2 - 1
                            NO√ãL</option>
                        <option value="3-4-3" {% if lineup.formation=='3-4-3' %}selected{% endif %}>3 - 4 - 3 ATTAQUANT
                        </option>
                    </optgroup>
                </select>
                <div class="absolute inset-y-0 right-5 flex items-center pointer-events-none text-primary-400">
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Area: Pitch + Bench -->
    <div class="flex-1 flex flex-col gap-6">
        <!-- Pitch Area -->
        <div class="flex-1 glass rounded-3xl border-white/5 bg-emerald-950/20 relative overflow-hidden group shadow-2xl"
            id="pitch" ondragover="onDragOverPitch(event)" ondrop="onDropPitch(event)">
            <!-- Pitch Markings -->
            <div class="absolute inset-0 opacity-20 pointer-events-none">
                <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <rect x="5" y="5" width="90" height="90" fill="none" stroke="white" stroke-width="0.5" rx="5" />
                    <line x1="5" y1="50" x2="95" y2="50" stroke="white" stroke-width="0.5" />
                    <circle cx="50" cy="50" r="10" fill="none" stroke="white" stroke-width="0.5" />
                    <rect x="30" y="5" width="40" height="12" fill="none" stroke="white" stroke-width="0.5" />
                    <rect x="30" y="83" width="40" height="12" fill="none" stroke="white" stroke-width="0.5" />
                </svg>
            </div>

            <!-- Players on Pitch -->
            <div class="absolute inset-0 z-10" id="pitchArea"></div>

            <!-- Pitch Controls -->
            <div class="absolute top-10 right-10 flex flex-col gap-4 z-20">
                <button onclick="saveTactics()" id="saveBtn"
                    class="w-14 h-14 rounded-2xl gradient-primary border border-white/20 flex items-center justify-center text-white hover:scale-105 active:scale-95 transition shadow-2xl shadow-primary-500/20"
                    title="Sauvegarder l'√©quipe type">
                    <i class="fa-solid fa-floppy-disk text-lg"></i>
                </button>
                <div class="flex flex-col gap-2 p-2 glass rounded-2xl border border-slate-200 dark:border-white/5">
                    <button onclick="openSavePresetModal()"
                        class="w-10 h-10 rounded-xl bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-slate-400 dark:text-white/50 hover:text-slate-900 dark:hover:text-white transition"
                        title="Enregistrer comme tactique">
                        <i class="fa-solid fa-bookmark"></i>
                    </button>
                    <button onclick="openLoadPresetModal()"
                        class="w-10 h-10 rounded-xl bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-slate-400 dark:text-white/50 hover:text-slate-900 dark:hover:text-white transition"
                        title="Charger une tactique">
                        <i class="fa-solid fa-folder-open"></i>
                    </button>
                    <div class="h-px bg-slate-200 dark:bg-white/5 mx-2 my-1"></div>
                    <button onclick="openCaptainsModal()"
                        class="w-10 h-10 rounded-xl bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-slate-400 dark:text-white/50 hover:text-slate-900 dark:hover:text-white transition"
                        title="G√©rer les capitaines">
                        <i class="fa-solid fa-copyright"></i>
                    </button>
                    <button onclick="openTakersModal()"
                        class="w-10 h-10 rounded-xl bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-slate-400 dark:text-white/50 hover:text-slate-900 dark:hover:text-white transition"
                        title="G√©rer les tireurs">
                        <i class="fa-solid fa-bullseye"></i>
                    </button>
                </div>
                <!-- Phase 2: Analytics Button -->
                <button onclick="openTacticsAnalytics()"
                    class="w-14 h-14 rounded-2xl glass hover:bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center text-indigo-400 hover:scale-105 active:scale-95 transition shadow-2xl"
                    title="Analytique Tactique">
                    <i class="fa-solid fa-chart-line text-lg"></i>
                </button>
                <!-- Phase 4: Visualiseur Button -->
                <button onclick="openVisualiser()"
                    class="w-14 h-14 rounded-2xl glass hover:bg-rose-500/20 border border-rose-500/30 flex items-center justify-center text-rose-400 hover:scale-105 active:scale-95 transition shadow-2xl"
                    title="Visualiseur Tactique">
                    <i class="fa-solid fa-play text-lg"></i>
                </button>
                <button onclick="openTacticalConfig()"
                    class="w-14 h-14 rounded-2xl glass hover:bg-amber-500/20 border border-amber-500/30 flex items-center justify-center text-amber-400 hover:scale-105 active:scale-95 transition shadow-2xl"
                    title="Configuration Tactique">
                    <i class="fa-solid fa-chess text-lg"></i>
                </button>
                <button onclick="resetPitch()"
                    class="w-14 h-14 rounded-2xl glass hover:bg-slate-100 dark:hover:bg-white/10 border border-slate-200 dark:border-white/20 flex items-center justify-center text-slate-700 dark:text-white transition shadow-2xl"
                    title="R√©initialiser">
                    <i class="fa-solid fa-rotate-left text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Bench / Substitutes -->
        <div class="glass rounded-3xl border-slate-200 dark:border-white/5 p-6" id="benchArea"
            ondragover="onDragOverBench(event)" ondrop="onDropBench(event)">
            <div class="flex items-center gap-3 mb-4">
                <i class="fa-solid fa-chair text-primary-400"></i>
                <h3 class="font-bold text-slate-900 dark:text-white text-xs uppercase tracking-wider">Banc des
                    rempla√ßants</h3>
                <span id="benchCount" class="text-[10px] text-slate-500 dark:text-white/30 font-bold">0 joueurs</span>
            </div>
            <div class="flex flex-wrap gap-3 min-h-[60px]" id="benchSlots">
                <div
                    class="bench-placeholder text-slate-400 dark:text-white/10 text-xs italic flex items-center justify-center w-full py-4">
                    Glissez des joueurs ici pour les ajouter au banc
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Player Slot Template -->
<template id="playerSlotTemplate">
    <div class="absolute flex flex-col items-center transition-all duration-500 cursor-pointer group/slot"
        style="left: 50%; top: 50%;">
        <div class="slot-circle w-14 h-14 rounded-2xl glass-light border-2 border-dashed border-slate-300 dark:border-white/20 flex items-center justify-center font-bold text-slate-400 dark:text-white/20 group-hover/slot:border-primary-500/50 transition-all"
            ondragover="onDragOverSlot(event)" ondrop="onDropSlot(event, this)">
        </div>
        <p
            class="slot-name mt-3 glass px-4 py-1.5 rounded-xl text-[9px] font-bold text-slate-600 dark:text-white/40 uppercase tracking-wider border border-slate-200 dark:border-white/5 shadow-2xl backdrop-blur-md">
            POSITION
        </p>
    </div>
</template>

<!-- Tactical Configuration Modal -->
<div id="tacticalModal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/80 dark:bg-black/80 backdrop-blur-xl"
    onclick="closeTacticalConfig(event)">
    <div class="tactical-modal-inner relative w-full lg:max-w-6xl h-full lg:h-[90vh] max-h-[95vh] mx-4 rounded-[40px] overflow-hidden flex flex-col transform scale-0 modal-inner-transition glass-dark border border-slate-200 dark:border-white/10 shadow-[0_0_100px_rgba(0,0,0,0.5)]"
        id="tacticalModalInner">

        <!-- Header -->
        <div class="relative px-8 py-8 border-b border-white/5 overflow-hidden">
            <div
                class="absolute inset-0 bg-gradient-to-r from-amber-500/10 via-transparent to-primary-500/10 opacity-30">
            </div>
            <div class="relative flex items-center justify-between z-10">
                <div class="flex items-center gap-6">
                    <div
                        class="w-16 h-16 rounded-[16px] bg-[#0f172a] border border-amber-500/30 flex items-center justify-center shadow-[0_0_20px_rgba(245,158,11,0.15)] group-hover:rotate-12 transition-transform duration-500 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-tr from-amber-500/20 to-transparent"></div>
                        <i class="fa-solid fa-chess-board text-amber-400 text-2xl relative z-10"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl lg:text-4xl font-[900] text-slate-900 dark:text-white uppercase italic tracking-tighter"
                            style="font-family: 'Oswald', sans-serif;">
                            TACTIQUE <span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-amber-600">ULTIMATE</span>
                        </h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
                            <p
                                class="text-[10px] text-slate-500 dark:text-white/40 font-bold uppercase tracking-[0.2em]">
                                Configuration
                                Strat√©gique en temps r√©el</p>
                        </div>
                    </div>
                </div>
                <button
                    onclick="closeTacticalConfig({target:document.getElementById('tacticalModal'),currentTarget:document.getElementById('tacticalModal')})"
                    class="w-12 h-12 rounded-2xl glass hover:bg-white/10 flex items-center justify-center text-white/40 hover:text-white transition-all duration-300 hover:rotate-90">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row overflow-hidden flex-1 min-h-0">
            <!-- Left: Options Scroll Area -->
            <div
                class="flex-1 p-6 lg:p-10 space-y-10 overflow-y-auto custom-scrollbar max-h-[50vh] lg:max-h-[calc(90vh-180px)]">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-10">
                    <!-- Style de passe -->
                    <div class="tactic-section group">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-lg bg-primary-500/10 flex items-center justify-center text-primary-400">
                                    <i class="fa-solid fa-arrows-turn-right text-sm"></i>
                                </div>
                                <h3 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-wider">
                                    Style de passe</h3>
                            </div>
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/20 font-bold uppercase tracking-widest">Offense</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3" id="passingStyle">
                            <button onclick="setTactic('passing', 'courte', this)" class="tactic-btn"
                                data-value="courte">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-square-small text-[10px]"></i></div>
                                <span>Courte</span>
                            </button>
                            <button onclick="setTactic('passing', 'direct', this)" class="tactic-btn"
                                data-value="direct">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-bolt text-[10px]"></i></div>
                                <span>Direct</span>
                            </button>
                            <button onclick="setTactic('passing', 'long', this)" class="tactic-btn" data-value="long">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-arrows-left-right text-[10px]"></i>
                                </div>
                                <span>Long</span>
                            </button>
                            <button onclick="setTactic('passing', 'mixte', this)" class="tactic-btn" data-value="mixte">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-shuffle text-[10px]"></i></div>
                                <span>Mixte</span>
                            </button>
                        </div>
                    </div>

                    <!-- Espace de jeu -->
                    <div class="tactic-section group">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-400">
                                    <i class="fa-solid fa-expand text-sm"></i>
                                </div>
                                <h3 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-wider">
                                    Espace de jeu</h3>
                            </div>
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/20 font-bold uppercase tracking-widest">Largeur</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3" id="playSpace">
                            <button onclick="setTactic('space', 'couloir_gauche', this)" class="tactic-btn"
                                data-value="couloir_gauche">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-arrow-left text-[10px]"></i></div>
                                <span>Couloir G</span>
                            </button>
                            <button onclick="setTactic('space', 'couloir_droit', this)" class="tactic-btn"
                                data-value="couloir_droit">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-arrow-right text-[10px]"></i></div>
                                <span>Couloir D</span>
                            </button>
                            <button onclick="setTactic('space', 'axe', this)" class="tactic-btn" data-value="axe">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-arrows-up-down text-[10px]"></i>
                                </div>
                                <span>Axe</span>
                            </button>
                            <button onclick="setTactic('space', 'deux_couloirs', this)" class="tactic-btn"
                                data-value="deux_couloirs">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-arrows-left-right text-[10px]"></i>
                                </div>
                                <span>Les 2 Couloirs</span>
                            </button>
                            <button onclick="setTactic('space', 'mixte', this)" class="tactic-btn col-span-2"
                                data-value="mixte">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-shuffle text-[10px]"></i></div>
                                <span>Mixte</span>
                            </button>
                        </div>
                    </div>

                    <!-- Style d√©fensif -->
                    <div class="tactic-section group">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400">
                                    <i class="fa-solid fa-shield-halved text-sm"></i>
                                </div>
                                <h3 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-wider">
                                    Ligne D√©fensive</h3>
                            </div>
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/20 font-bold uppercase tracking-widest">Position</span>
                        </div>
                        <div class="grid grid-cols-3 gap-3" id="defensiveStyle">
                            <button onclick="setTactic('defensive', 'bloc_bas', this)" class="tactic-btn"
                                data-value="bloc_bas">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-arrow-down text-[10px]"></i></div>
                                <span>Bas</span>
                            </button>
                            <button onclick="setTactic('defensive', 'bloc_median', this)" class="tactic-btn"
                                data-value="bloc_median">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-minus text-[10px]"></i></div>
                                <span>M√©dian</span>
                            </button>
                            <button onclick="setTactic('defensive', 'bloc_haut', this)" class="tactic-btn"
                                data-value="bloc_haut">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-arrow-up text-[10px]"></i></div>
                                <span>Haut</span>
                            </button>
                        </div>
                    </div>

                    <!-- Pressing -->
                    <div class="tactic-section group">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center text-red-400">
                                    <i class="fa-solid fa-fire text-sm"></i>
                                </div>
                                <h3 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-wider">
                                    Intensit√© Pressing
                                </h3>
                            </div>
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/20 font-bold uppercase tracking-widest">√ânergie</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3" id="pressingStyle">
                            <button onclick="setTactic('pressing', 'bas', this)" class="tactic-btn" data-value="bas">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-angles-down text-[10px]"></i></div>
                                <span>Pressing Bas</span>
                            </button>
                            <button onclick="setTactic('pressing', 'median', this)" class="tactic-btn"
                                data-value="median">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-grip-lines text-[10px]"></i></div>
                                <span>Pressing M√©dian</span>
                            </button>
                            <button onclick="setTactic('pressing', 'haut', this)" class="tactic-btn" data-value="haut">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-angles-up text-[10px]"></i></div>
                                <span>Pressing Haut</span>
                            </button>
                            <button onclick="setTactic('pressing', 'tout_terrain', this)" class="tactic-btn"
                                data-value="tout_terrain">
                                <div class="tactic-btn-icon"><i class="fa-solid fa-explosion text-[10px]"></i></div>
                                <span>Tout Terrain</span>
                            </button>
                        </div>
                    </div>

                    <!-- Marquage -->
                    <div class="tactic-section group">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-lg bg-violet-500/10 flex items-center justify-center text-violet-400">
                                    <i class="fa-solid fa-crosshairs text-sm"></i>
                                </div>
                                <h3 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-wider">
                                    Marquage</h3>
                            </div>
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/20 font-bold uppercase tracking-widest">D√©fense</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3" id="markingStyle">
                            <button onclick="setTactic('marking', 'individuel', this)" class="tactic-btn"
                                data-value="individuel">
                                <i class="fa-solid fa-user-lock text-[10px] mb-1"></i>
                                <span>Individuel</span>
                            </button>
                            <button onclick="setTactic('marking', 'zone', this)" class="tactic-btn" data-value="zone">
                                <i class="fa-solid fa-border-all text-[10px] mb-1"></i>
                                <span>Zone</span>
                            </button>
                        </div>
                    </div>

                    <!-- Relance Gardien -->
                    <div class="tactic-section group">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-lg bg-orange-500/10 flex items-center justify-center text-orange-400">
                                    <i class="fa-solid fa-hands-holding-circle text-sm"></i>
                                </div>
                                <h3 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-wider">
                                    Relance Gardien</h3>
                            </div>
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/20 font-bold uppercase tracking-widest">Gardien</span>
                        </div>
                        <div class="grid grid-cols-3 gap-3" id="gkStyle">
                            <button onclick="setTactic('goalkeeper_distribution', 'courte', this)" class="tactic-btn"
                                data-value="courte">
                                <i class="fa-solid fa-hand-point-down text-[10px] mb-1"></i>
                                <span>Courte</span>
                            </button>
                            <button onclick="setTactic('goalkeeper_distribution', 'longue', this)" class="tactic-btn"
                                data-value="longue">
                                <i class="fa-solid fa-arrow-up-right-from-square text-[10px] mb-1"></i>
                                <span>Longue</span>
                            </button>
                            <button onclick="setTactic('goalkeeper_distribution', 'rapide', this)" class="tactic-btn"
                                data-value="rapide">
                                <i class="fa-solid fa-bolt text-[10px] mb-1"></i>
                                <span>Rapide</span>
                            </button>
                        </div>
                    </div>

                    <!-- Contre-pressing toggle -->
                    <div class="tactic-section">
                        <div class="flex items-center gap-3 mb-5">
                            <div
                                class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center text-amber-400">
                                <i class="fa-solid fa-bolt-lightning text-sm"></i>
                            </div>
                            <h3 class="text-sm font-black text-white uppercase tracking-wider">Phase de Transition</h3>
                        </div>
                        <label
                            class="relative flex items-center justify-between p-6 rounded-[24px] bg-slate-50 dark:bg-white/[0.03] border border-slate-200 dark:border-white/5 cursor-pointer hover:bg-slate-100 dark:hover:bg-white/5 hover:border-amber-500/30 transition-all duration-300 group"
                            id="counterPressingToggle">
                            <div class="flex flex-col gap-1">
                                <p class="text-xs font-bold text-slate-900 dark:text-white uppercase tracking-wider">
                                    Contre-pressing</p>
                                <p class="text-[9px] text-slate-500 dark:text-white/30 font-medium">R√©cup√©ration
                                    ultra-rapide</p>
                            </div>
                            <div class="w-14 h-8 rounded-full bg-slate-200 dark:bg-white/5 border border-slate-300 dark:border-white/10 relative transition-all duration-500"
                                id="cpToggleBg">
                                <div class="w-6 h-6 rounded-full bg-white dark:bg-white/20 absolute top-1 left-1 shadow-lg transition-all duration-500"
                                    id="cpToggleDot"></div>
                            </div>
                            <input type="checkbox" id="counterPressing" class="hidden"
                                onchange="setCounterPressing(this.checked)">
                        </label>
                    </div>
                </div>
            </div>

            <!-- Right: Premium Preview -->
            <div
                class="w-full lg:w-[450px] bg-black/40 border-t lg:border-t-0 lg:border-l border-white/5 flex flex-col relative overflow-y-auto lg:overflow-hidden custom-scrollbar">
                <!-- Abstract BG patterns -->
                <div class="absolute inset-0 opacity-20 pointer-events-none">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-primary-500/10 blur-[100px] rounded-full"></div>
                    <div class="absolute bottom-0 left-0 w-64 h-64 bg-amber-500/10 blur-[100px] rounded-full"></div>
                </div>

                <div class="p-8 lg:p-10 flex flex-col h-full relative z-10">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-xs font-black text-white/30 uppercase tracking-[0.2em]">Visualiseur Tactique
                        </h3>
                        <div class="flex gap-1">
                            <div class="w-1.5 h-1.5 rounded-full bg-primary-500"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-amber-500"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                        </div>
                    </div>

                    <div
                        class="flex-1 relative rounded-[32px] bg-[#022c22]/30 border border-emerald-500/20 overflow-hidden shadow-inner group">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                        <svg id="previewPitch" viewBox="0 0 300 450" class="w-full h-full relative z-10"
                            xmlns="http://www.w3.org/2000/svg">
                            <!-- Field Markings -->
                            <rect x="10" y="10" width="280" height="430" rx="20" fill="none"
                                stroke="rgba(255,255,255,0.08)" stroke-width="1" />
                            <line x1="10" y1="225" x2="290" y2="225" stroke="rgba(255,255,255,0.08)" stroke-width="1" />
                            <circle cx="150" cy="225" r="45" fill="none" stroke="rgba(255,255,255,0.08)"
                                stroke-width="1" />

                            <!-- Dynamic Tactical Zones -->
                            <rect id="pvZoneLeft" x="10" y="10" width="80" height="430" fill="transparent"
                                class="transition-all duration-700 ease-out" />
                            <rect id="pvZoneRight" x="210" y="10" width="80" height="430" fill="transparent"
                                class="transition-all duration-700 ease-out" />
                            <rect id="pvZoneCenter" x="90" y="10" width="120" height="430" fill="transparent"
                                class="transition-all duration-700 ease-out" />

                            <!-- Defensive & Pressing Lines -->
                            <g class="lines-group">
                                <line id="pvDefLine" x1="20" y1="340" x2="280" y2="340" stroke="rgba(59,130,246,0.6)"
                                    stroke-width="3" stroke-dasharray="10,5" class="transition-all duration-700" />
                                <text id="pvDefLabel" x="150" y="358" text-anchor="middle" fill="rgba(59,130,246,0.8)"
                                    font-size="10" font-weight="900" class="transition-all duration-700">BLOC
                                    M√âDIAN</text>

                                <line id="pvPressLine" x1="20" y1="180" x2="280" y2="180" stroke="rgba(239,68,68,0.6)"
                                    stroke-width="3" stroke-dasharray="10,5" class="transition-all duration-700" />
                                <text id="pvPressLabel" x="150" y="172" text-anchor="middle" fill="rgba(239,68,68,0.8)"
                                    font-size="10" font-weight="900"
                                    class="transition-all duration-700 uppercase">Pressing</text>
                            </g>

                            <!-- Animation elements -->
                            <g id="pvPassArrows" class="transition-all duration-700"></g>
                            <g id="pvMarking" class="transition-all duration-700"></g>

                            <!-- Counter pressing indicator -->
                            <g id="pvCounterPress" opacity="0" class="transition-all duration-700 origin-center">
                                <circle cx="150" cy="225" r="30" fill="rgba(245,158,11,0.1)"
                                    stroke="rgba(245,158,11,0.5)" stroke-width="2" class="animate-pulse" />
                                <text x="150" y="228" text-anchor="middle" fill="rgba(245,158,11,0.9)" font-size="8"
                                    font-weight="900">GEGENPRESSING</text>
                            </g>
                        </svg>
                    </div>

                    <!-- Config summary Card -->
                    <div
                        class="mt-8 p-6 rounded-[30px] glass-dark border border-slate-200 dark:border-white/5 shadow-xl">
                        <div class="flex items-center justify-between mb-4">
                            <p
                                class="text-[10px] text-slate-400 dark:text-white/20 font-black uppercase tracking-[0.2em]">
                                Tableau de Bord
                            </p>
                            <i class="fa-solid fa-list-check text-slate-400 dark:text-white/20 text-xs"></i>
                        </div>
                        <div class="space-y-3" id="configSummary">
                            <div class="flex items-center justify-center py-4">
                                <p class="text-xs text-slate-500 dark:text-white/30 italic">Configuration vierge...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div
            class="relative px-8 py-8 border-t border-slate-200 dark:border-white/5 bg-slate-50/50 dark:bg-black/20 overflow-hidden">
            <div class="relative flex items-center justify-between z-10 gap-6">
                <button onclick="resetTacticalConfig()"
                    class="group flex items-center gap-3 px-8 py-4 rounded-[20px] glass hover:bg-slate-100 dark:hover:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-500 dark:text-white/50 hover:text-slate-900 dark:hover:text-white text-xs font-bold uppercase tracking-wider transition-all duration-300">
                    <i class="fa-solid fa-rotate-left group-hover:-rotate-45 transition-transform duration-300"></i>
                    <span>R√©initialiser</span>
                </button>
                <button onclick="saveTacticalConfig()" id="saveTacConfigBtn"
                    class="group flex-1 lg:flex-none lg:px-14 py-4 rounded-[20px] bg-gradient-to-r from-amber-400 to-amber-600 text-black text-sm font-black uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 shadow-[0_12px_40px_rgba(245,158,11,0.2)] flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check"></i>
                    <span>Optimiser & Valider</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PHASE 2: TACTIQUE ULTIMATE ANALYTICS Modal -->
<div id="tacticsAnalyticsModal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/80 dark:bg-black/80 backdrop-blur-xl"
    onclick="closeTacticsAnalytics(event)">
    <div class="tactical-modal-inner relative w-full lg:max-w-7xl h-full lg:h-[90vh] max-h-[95vh] mx-4 rounded-[40px] overflow-hidden flex flex-col transform scale-0 modal-inner-transition glass-dark border border-slate-200 dark:border-white/10 shadow-[0_0_100px_rgba(0,0,0,0.5)]"
        id="analyticsModalInner">

        <!-- Header -->
        <div class="relative px-8 py-8 border-b border-white/5 overflow-hidden">
            <div
                class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 via-transparent to-purple-500/10 opacity-30">
            </div>
            <div class="relative flex items-center justify-between z-10">
                <div class="flex items-center gap-6">
                    <div
                        class="w-16 h-16 rounded-[16px] bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center shadow-[0_0_20px_rgba(99,102,241,0.15)]">
                        <i class="fa-solid fa-chart-line text-indigo-400 text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl lg:text-4xl font-[900] text-slate-900 dark:text-white uppercase italic tracking-tighter"
                            style="font-family: 'Oswald', sans-serif;">
                            ANALYTIQUE <span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">TACTIQUE</span>
                        </h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                            <p
                                class="text-[10px] text-slate-500 dark:text-white/40 font-bold uppercase tracking-[0.2em]">
                                M√©triques & Chimie en temps r√©el</p>
                        </div>
                    </div>
                </div>
                <button
                    onclick="closeTacticsAnalytics({target:document.getElementById('tacticsAnalyticsModal'),currentTarget:document.getElementById('tacticsAnalyticsModal')})"
                    class="w-12 h-12 rounded-2xl glass hover:bg-white/10 flex items-center justify-center text-white/40 hover:text-white transition-all duration-300 hover:rotate-90">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div
            class="px-8 py-4 border-b border-white/5 flex gap-2 overflow-x-auto custom-scrollbar bg-slate-50/5 dark:bg-black/20">
            <button onclick="switchAnalyticsTab('metrics', this)"
                class="analytics-tab active px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="metrics">
                <i class="fa-solid fa-chart-simple text-sm mr-2"></i>M√©triques
            </button>
            <button onclick="switchAnalyticsTab('chemistry', this)"
                class="analytics-tab px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="chemistry">
                <i class="fa-solid fa-link text-sm mr-2"></i>Chimie
            </button>
            <button onclick="switchAnalyticsTab('suggestions', this)"
                class="analytics-tab px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="suggestions">
                <i class="fa-solid fa-lightbulb text-sm mr-2"></i>Suggestions
            </button>
            <button onclick="switchAnalyticsTab('heatmap', this)"
                class="analytics-tab px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="heatmap">
                <i class="fa-solid fa-fire text-sm mr-2"></i>Heat Map
            </button>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-8">
            <!-- Metrics Tab -->
            <div id="metricsTab" class="analytics-content space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Metric Card: Defensive Width -->
                    <div
                        class="glass-dark border border-white/5 rounded-[24px] p-6 hover:border-indigo-500/30 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest">Largeur
                                D√©fense</span>
                            <i class="fa-solid fa-arrows-left-right text-indigo-400"></i>
                        </div>
                        <div class="text-3xl font-[900] text-white mb-2" id="metricDefWidth">87%</div>
                        <div class="h-2 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-full"
                                style="width: 87%"></div>
                        </div>
                    </div>

                    <!-- Metric Card: Attack Depth -->
                    <div
                        class="glass-dark border border-white/5 rounded-[24px] p-6 hover:border-purple-500/30 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest">Profondeur
                                Attaque</span>
                            <i class="fa-solid fa-arrows-up-down text-purple-400"></i>
                        </div>
                        <div class="text-3xl font-[900] text-white mb-2" id="metricAttackDepth">72%</div>
                        <div class="h-2 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-purple-500 to-purple-600 rounded-full"
                                style="width: 72%"></div>
                        </div>
                    </div>

                    <!-- Metric Card: Compactness -->
                    <div
                        class="glass-dark border border-white/5 rounded-[24px] p-6 hover:border-cyan-500/30 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest">Compacit√©</span>
                            <i class="fa-solid fa-circle text-cyan-400"></i>
                        </div>
                        <div class="text-3xl font-[900] text-white mb-2" id="metricCompactness">81%</div>
                        <div class="h-2 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-full"
                                style="width: 81%"></div>
                        </div>
                    </div>

                    <!-- Metric Card: Balance -->
                    <div
                        class="glass-dark border border-white/5 rounded-[24px] p-6 hover:border-emerald-500/30 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <span
                                class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest">√âquilibre
                                A/D</span>
                            <i class="fa-solid fa-scale-balanced text-emerald-400"></i>
                        </div>
                        <div class="text-3xl font-[900] text-white mb-2" id="metricBalance">62%</div>
                        <div class="h-2 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-full"
                                style="width: 62%"></div>
                        </div>
                    </div>
                </div>

                <!-- Formation Fit Score -->
                <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <p
                                class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-2">
                                Score d'Ad√©quation Formation</p>
                            <h3 class="text-2xl font-[900] text-white">Tr√®s Bon</h3>
                        </div>
                        <div
                            class="text-5xl font-[900] text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">
                            87</div>
                    </div>
                    <div class="h-3 rounded-full bg-white/5 overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500 rounded-full"
                            style="width: 87%; background-size: 200% 100%; animation: gradientShift 3s ease infinite;">
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 dark:text-white/40 mt-4">Cette formation s'adapte bien √† votre
                        effectif avec un bon √©quilibre attaque/d√©fense.</p>
                </div>
            </div>

            <!-- Chemistry Tab -->
            <div id="chemistryTab" class="analytics-content hidden space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Overall Chemistry -->
                    <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <p
                                    class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-2">
                                    Chimie Globale</p>
                                <h3 class="text-2xl font-[900] text-white">Excellent</h3>
                            </div>
                            <div
                                class="text-5xl font-[900] text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">
                                94</div>
                        </div>
                        <div class="h-3 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-full"
                                style="width: 94%;"></div>
                        </div>
                    </div>

                    <!-- Defensive Chemistry -->
                    <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <p
                                    class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-2">
                                    Chimie D√©fense</p>
                                <h3 class="text-2xl font-[900] text-white">Tr√®s Bonne</h3>
                            </div>
                            <div
                                class="text-5xl font-[900] text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-blue-400">
                                88</div>
                        </div>
                        <div class="h-3 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full"
                                style="width: 88%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Midfield & Attack Chemistry -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Midfield Chemistry -->
                    <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <p
                                    class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-2">
                                    Chimie Milieu</p>
                                <h3 class="text-2xl font-[900] text-white">Excellent</h3>
                            </div>
                            <div
                                class="text-5xl font-[900] text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-400">
                                91</div>
                        </div>
                        <div class="h-3 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full"
                                style="width: 91%;"></div>
                        </div>
                    </div>

                    <!-- Attack Chemistry -->
                    <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <p
                                    class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-2">
                                    Chimie Attaque</p>
                                <h3 class="text-2xl font-[900] text-white">Bonne</h3>
                            </div>
                            <div
                                class="text-5xl font-[900] text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-pink-400">
                                79</div>
                        </div>
                        <div class="h-3 rounded-full bg-white/5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-red-500 to-pink-500 rounded-full"
                                style="width: 79%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suggestions Tab -->
            <div id="suggestionsTab" class="analytics-content hidden space-y-6">
                <div class="space-y-4" id="suggestionsList">
                    <!-- Suggestion Item -->
                    <div
                        class="glass-dark border border-emerald-500/20 rounded-[24px] p-6 hover:border-emerald-500/40 transition-all">
                        <div class="flex gap-4">
                            <div
                                class="w-12 h-12 rounded-[12px] bg-emerald-500/10 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-check-circle text-emerald-400 text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-[900] text-white mb-1">Bonne Formation</h4>
                                <p class="text-[12px] text-slate-400 dark:text-white/40 leading-relaxed">
                                    Votre formation 4-3-3 est bien adapt√©e √† votre effectif. Les positions sont bien
                                    distribu√©es.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestion Item -->
                    <div
                        class="glass-dark border border-amber-500/20 rounded-[24px] p-6 hover:border-amber-500/40 transition-all">
                        <div class="flex gap-4">
                            <div
                                class="w-12 h-12 rounded-[12px] bg-amber-500/10 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-lightbulb text-amber-400 text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-[900] text-white mb-1">Ajuster les Ailes</h4>
                                <p class="text-[12px] text-slate-400 dark:text-white/40 leading-relaxed">
                                    Consid√©rez d'utiliser des ailiers plus rapides pour exploiter les flancs. Cela
                                    augmenterait votre capacit√© offensif.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestion Item -->
                    <div
                        class="glass-dark border border-indigo-500/20 rounded-[24px] p-6 hover:border-indigo-500/40 transition-all">
                        <div class="flex gap-4">
                            <div
                                class="w-12 h-12 rounded-[12px] bg-indigo-500/10 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-chart-line text-indigo-400 text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-[900] text-white mb-1">Am√©liorer la Profondeur</h4>
                                <p class="text-[12px] text-slate-400 dark:text-white/40 leading-relaxed">
                                    Augmentez la profondeur offensive en avan√ßant le milieu de terrain central pour plus
                                    de pr√©sence en attaque.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HeatMap Tab -->
            <div id="heatmapTab" class="analytics-content hidden">
                <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                    <div class="text-center">
                        <p
                            class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-4">
                            Couverture Terrain</p>
                        <svg viewBox="0 0 105 68" class="w-full max-w-2xl mx-auto" id="heatmapPitch">
                            <!-- Pitch background -->
                            <rect width="105" height="68" fill="url(#pitchGradient)" opacity="0.3" />
                            <!-- Heat map circles -->
                            <circle cx="52.5" cy="34" r="25" fill="url(#heatGradient)" opacity="0.6" />
                            <circle cx="20" cy="20" r="15" fill="url(#heatGradient2)" opacity="0.5" />
                            <circle cx="85" cy="20" r="15" fill="url(#heatGradient2)" opacity="0.5" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="relative px-8 py-8 border-t border-white/5 bg-slate-50/50 dark:bg-black/20">
            <div class="relative flex items-center justify-between z-10">
                <p class="text-[10px] text-slate-500 dark:text-white/40 font-bold uppercase tracking-wider">Derni√®re
                    mise √† jour: <span id="analyticsTimestamp">√† l'instant</span></p>
                <button
                    onclick="closeTacticsAnalytics({target:document.getElementById('tacticsAnalyticsModal'),currentTarget:document.getElementById('tacticsAnalyticsModal')})"
                    class="px-8 py-3 rounded-[16px] glass hover:bg-white/10 text-white/60 hover:text-white text-xs font-bold uppercase tracking-wider transition-all">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PHASE 4: VISUALISEUR TACTIQUE Modal -->
<div id="visualiserModal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/80 dark:bg-black/80 backdrop-blur-xl"
    onclick="closeVisualiser(event)">
    <div class="tactical-modal-inner relative w-full lg:max-w-6xl h-full lg:h-[90vh] max-h-[95vh] mx-4 rounded-[40px] overflow-hidden flex flex-col transform scale-0 modal-inner-transition glass-dark border border-slate-200 dark:border-white/10 shadow-[0_0_100px_rgba(0,0,0,0.5)]"
        id="visualiserModalInner">

        <!-- Header -->
        <div class="relative px-8 py-8 border-b border-white/5 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-rose-500/10 via-transparent to-pink-500/10 opacity-30"></div>
            <div class="relative flex items-center justify-between z-10">
                <div class="flex items-center gap-6">
                    <div class="w-16 h-16 rounded-[16px] bg-gradient-to-br from-rose-500/20 to-pink-500/20 border border-rose-500/30 flex items-center justify-center shadow-[0_0_20px_rgba(244,63,94,0.15)]">
                        <i class="fa-solid fa-play text-rose-400 text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl lg:text-4xl font-[900] text-slate-900 dark:text-white uppercase italic tracking-tighter"
                            style="font-family: 'Oswald', sans-serif;">
                            VISUALISEUR <span class="text-transparent bg-clip-text bg-gradient-to-r from-rose-400 to-pink-400">TACTIQUE</span>
                        </h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
                            <p class="text-[10px] text-slate-500 dark:text-white/40 font-bold uppercase tracking-[0.2em]">
                                Pr√©visualisation en temps r√©el</p>
                        </div>
                    </div>
                </div>
                <button onclick="closeVisualiser({target:document.getElementById('visualiserModal'),currentTarget:document.getElementById('visualiserModal')})"
                    class="w-12 h-12 rounded-2xl glass hover:bg-white/10 flex items-center justify-center text-white/40 hover:text-white transition-all duration-300 hover:rotate-90">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Visualization Tabs -->
        <div class="px-8 py-4 border-b border-white/5 flex gap-2 overflow-x-auto custom-scrollbar bg-slate-50/5 dark:bg-black/20">
            <button onclick="switchVisualiserTab('pitch', this)" class="visualiser-tab active px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="pitch">
                <i class="fa-solid fa-futbol text-sm mr-2"></i>Terrain
            </button>
            <button onclick="switchVisualiserTab('coverage', this)" class="visualiser-tab px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="coverage">
                <i class="fa-solid fa-fire text-sm mr-2"></i>Couverture
            </button>
            <button onclick="switchVisualiserTab('passing', this)" class="visualiser-tab px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="passing">
                <i class="fa-solid fa-arrows text-sm mr-2"></i>Passes
            </button>
            <button onclick="switchVisualiserTab('phases', this)" class="visualiser-tab px-6 py-3 rounded-[16px] text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all duration-300"
                data-tab="phases">
                <i class="fa-solid fa-circle-play text-sm mr-2"></i>Phases
            </button>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-8 bg-gradient-to-b from-slate-900/20 to-transparent">
            <!-- Pitch Tab -->
            <div id="pitchTab" class="visualiser-content space-y-6">
                <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                    <p class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-6">Visualisation Terrain</p>
                    <svg viewBox="0 0 105 68" class="w-full max-w-4xl mx-auto" id="mainPitch" style="min-height: 300px;">
                        <!-- Pitch background -->
                        <rect width="105" height="68" fill="#047857" opacity="0.6"/>
                        <!-- Pitch lines -->
                        <line x1="52.5" y1="0" x2="52.5" y2="68" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <line x1="0" y1="34" x2="105" y2="34" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <rect x="0" y="13.6" width="16.5" height="40.8" fill="none" stroke="white" stroke-width="0.3" opacity="0.3"/>
                        <rect x="88.5" y="13.6" width="16.5" height="40.8" fill="none" stroke="white" stroke-width="0.3" opacity="0.3"/>
                        <!-- Center circle -->
                        <circle cx="52.5" cy="34" r="9.15" fill="none" stroke="white" stroke-width="0.3" opacity="0.3"/>
                        <!-- Animated player positions -->
                        <g id="playerPositions"></g>
                    </svg>
                    <p class="text-xs text-white/40 text-center mt-4">Formation actuelle avec positionnement des joueurs</p>
                </div>
            </div>

            <!-- Coverage Tab -->
            <div id="coverageTab" class="visualiser-content hidden space-y-6">
                <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                    <p class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-6">Zones de Couverture</p>
                    <svg viewBox="0 0 105 68" class="w-full max-w-4xl mx-auto" id="coveragePitch" style="min-height: 300px;">
                        <rect width="105" height="68" fill="#047857" opacity="0.6"/>
                        <line x1="52.5" y1="0" x2="52.5" y2="68" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <line x1="0" y1="34" x2="105" y2="34" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <!-- Coverage zones -->
                        <g id="coverageZones" opacity="0.5"></g>
                    </svg>
                    <p class="text-xs text-white/40 text-center mt-4">Zones de couverture par ligne (D√©fense, Milieu, Attaque)</p>
                </div>
            </div>

            <!-- Passing Lines Tab -->
            <div id="passingTab" class="visualiser-content hidden space-y-6">
                <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                    <p class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-6">Lignes de Passe</p>
                    <svg viewBox="0 0 105 68" class="w-full max-w-4xl mx-auto" id="passingPitch" style="min-height: 300px;">
                        <rect width="105" height="68" fill="#047857" opacity="0.6"/>
                        <line x1="52.5" y1="0" x2="52.5" y2="68" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <line x1="0" y1="34" x2="105" y2="34" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <!-- Passing lines -->
                        <g id="passingLines" opacity="0.6"></g>
                    </svg>
                    <p class="text-xs text-white/40 text-center mt-4">Lignes de passe entre joueurs proches</p>
                </div>
            </div>

            <!-- Game Phases Tab -->
            <div id="phasesTab" class="visualiser-content hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <button onclick="switchPhase('defense')" class="phase-btn active px-6 py-4 rounded-[16px] text-sm font-bold uppercase tracking-wider transition-all"
                        data-phase="defense">
                        <i class="fa-solid fa-shield text-lg mb-2 block"></i>D√âFENSE
                    </button>
                    <button onclick="switchPhase('transition')" class="phase-btn px-6 py-4 rounded-[16px] text-sm font-bold uppercase tracking-wider transition-all"
                        data-phase="transition">
                        <i class="fa-solid fa-arrows-rotate text-lg mb-2 block"></i>TRANSITION
                    </button>
                    <button onclick="switchPhase('attack')" class="phase-btn px-6 py-4 rounded-[16px] text-sm font-bold uppercase tracking-wider transition-all"
                        data-phase="attack">
                        <i class="fa-solid fa-triangle-exclamation text-lg mb-2 block"></i>ATTAQUE
                    </button>
                </div>

                <div class="glass-dark border border-white/5 rounded-[24px] p-8">
                    <p class="text-[10px] text-slate-400 dark:text-white/40 font-bold uppercase tracking-widest mb-6" id="phaseTitle">Phase D√©fensive</p>
                    <svg viewBox="0 0 105 68" class="w-full max-w-4xl mx-auto" id="phasesPitch" style="min-height: 300px;">
                        <rect width="105" height="68" fill="#047857" opacity="0.6"/>
                        <line x1="52.5" y1="0" x2="52.5" y2="68" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <line x1="0" y1="34" x2="105" y2="34" stroke="white" stroke-width="0.5" opacity="0.4"/>
                        <!-- Phase visualization -->
                        <g id="phaseContent"></g>
                    </svg>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-dark border border-indigo-500/20 rounded-[16px] p-4">
                        <p class="text-[9px] text-indigo-400 font-bold uppercase tracking-wider mb-2"><i class="fa-solid fa-shield mr-1"></i>Bloc D√©fensif</p>
                        <p class="text-xs text-white/60" id="defenseInfo">Haut</p>
                    </div>
                    <div class="glass-dark border border-purple-500/20 rounded-[16px] p-4">
                        <p class="text-[9px] text-purple-400 font-bold uppercase tracking-wider mb-2"><i class="fa-solid fa-person mr-1"></i>Pressing</p>
                        <p class="text-xs text-white/60" id="pressingInfo">Median</p>
                    </div>
                    <div class="glass-dark border border-rose-500/20 rounded-[16px] p-4">
                        <p class="text-[9px] text-rose-400 font-bold uppercase tracking-wider mb-2"><i class="fa-solid fa-forward mr-1"></i>Attaque</p>
                        <p class="text-xs text-white/60" id="attackInfo">Profonde</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="relative px-8 py-8 border-t border-white/5 bg-slate-50/50 dark:bg-black/20 overflow-hidden">
            <div class="relative flex items-center justify-between z-10 gap-6">
                <button onclick="playVisualisationAnimation()" class="group flex items-center gap-3 px-8 py-4 rounded-[20px] glass hover:bg-white/10 border border-white/10 text-white/60 hover:text-white text-xs font-bold uppercase tracking-wider transition-all duration-300">
                    <i class="fa-solid fa-play group-hover:scale-125 transition-transform"></i>
                    <span>Animer</span>
                </button>
                <button onclick="closeVisualiser({target:document.getElementById('visualiserModal'),currentTarget:document.getElementById('visualiserModal')})"
                    class="px-8 py-3 rounded-[16px] glass hover:bg-white/10 text-white/60 hover:text-white text-xs font-bold uppercase tracking-wider transition-all">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- FIFA Player Card Modal -->
<div id="fifaModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm"
    onclick="closeFifaModal(event)">
    <div class="fifa-card relative w-80 rounded-3xl overflow-hidden transform scale-0 transition-transform duration-300"
        id="fifaCardInner">
        <!-- Gold gradient top -->
        <div class="bg-gradient-to-br from-amber-400 via-yellow-500 to-amber-600 p-1 rounded-3xl">
            <div class="bg-gradient-to-br from-gray-900 via-slate-800 to-gray-900 rounded-[22px] overflow-hidden">
                <!-- Header with overall rating -->
                <div class="bg-gradient-to-r from-amber-500/20 to-transparent p-6 pb-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="text-5xl font-black text-amber-400" id="fifaOverall">85</div>
                            <div class="text-xs font-bold text-amber-400/60 uppercase tracking-widest mt-1"
                                id="fifaPosition">ST</div>
                        </div>
                        <div
                            class="w-20 h-20 rounded-2xl bg-gradient-to-br from-amber-400/20 to-amber-600/10 border-2 border-amber-500/30 flex items-center justify-center">
                            <span class="text-3xl font-black text-white" id="fifaNumber">9</span>
                        </div>
                    </div>
                </div>

                <!-- Player Name -->
                <div class="px-6 py-3 border-t border-amber-500/20">
                    <h2 class="text-xl font-black text-white uppercase tracking-wider" id="fifaName">JOUEUR</h2>
                    <p class="text-[10px] text-amber-400/50 font-bold uppercase tracking-widest mt-1" id="fifaClub">
                        FootLogic Elite</p>
                </div>

                <!-- Stats Grid -->
                <div class="px-6 pb-6 pt-2">
                    <div class="grid grid-cols-3 gap-3">
                        <div
                            class="fifa-stat text-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 transition">
                            <div class="text-xl font-black text-white" id="fifaVIT">50</div>
                            <div class="text-[8px] font-bold text-amber-400/60 uppercase tracking-widest">VIT</div>
                        </div>
                        <div
                            class="fifa-stat text-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 transition">
                            <div class="text-xl font-black text-white" id="fifaTIR">50</div>
                            <div class="text-[8px] font-bold text-amber-400/60 uppercase tracking-widest">TIR</div>
                        </div>
                        <div
                            class="fifa-stat text-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 transition">
                            <div class="text-xl font-black text-white" id="fifaPAS">50</div>
                            <div class="text-[8px] font-bold text-amber-400/60 uppercase tracking-widest">PAS</div>
                        </div>
                        <div
                            class="fifa-stat text-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 transition">
                            <div class="text-xl font-black text-white" id="fifaDRI">50</div>
                            <div class="text-[8px] font-bold text-amber-400/60 uppercase tracking-widest">DRI</div>
                        </div>
                        <div
                            class="fifa-stat text-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 transition">
                            <div class="text-xl font-black text-white" id="fifaDEF">50</div>
                            <div class="text-[8px] font-bold text-amber-400/60 uppercase tracking-widest">DEF</div>
                        </div>
                        <div
                            class="fifa-stat text-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 transition">
                            <div class="text-xl font-black text-white" id="fifaPHY">50</div>
                            <div class="text-[8px] font-bold text-amber-400/60 uppercase tracking-widest">PHY</div>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="px-6 pb-6">
                    <button onclick="removePlayerFromSlot()"
                        class="w-full py-3 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-bold uppercase tracking-wider hover:bg-red-500/20 transition">
                        <i class="fa-solid fa-xmark mr-2"></i>Retirer du terrain
                    </button>
                </div>
            </div>
        </div>

        <!-- Save Preset Modal -->
        <div id="savePresetModal"
            class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/80 dark:bg-black/80 backdrop-blur-sm"
            onclick="closeSavePresetModal(event)">
            <div class="w-full max-w-md bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-white/10 rounded-3xl p-8 shadow-2xl modal-inner-transition transform scale-0 relative"
                id="savePresetModalInner">
                <button onclick="closeSavePresetModal({target:this, currentTarget:this})"
                    class="absolute top-4 right-4 text-slate-400 dark:text-white/20 hover:text-slate-900 dark:hover:text-white transition">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>

                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-3">
                    <i class="fa-solid fa-bookmark text-primary-400"></i>
                    Sauvegarder la Tactique
                </h3>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-500 dark:text-white/40 uppercase tracking-wider mb-2">Nom
                            de la
                            tactique</label>
                        <input type="text" id="presetName" placeholder="ex: 4-3-3 Attaque Total"
                            class="w-full bg-slate-50 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-primary-500 transition">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-500 dark:text-white/40 uppercase tracking-wider mb-2">Description
                            (Optionnel)</label>
                        <textarea id="presetDesc" placeholder="Utiliser contre les √©quipes d√©fensives..." rows="3"
                            class="w-full bg-slate-50 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-primary-500 transition"></textarea>
                    </div>

                    <button onclick="submitSavePreset()" id="btnSavePreset"
                        class="w-full py-4 rounded-xl gradient-primary text-white font-bold uppercase tracking-wider hover:opacity-90 transition shadow-lg shadow-primary-500/20 mt-2">
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>

        <!-- Load Preset Modal - SIMPLIFIED & INTERACTIVE -->
        <div id="loadPresetModal"
            class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/80 dark:bg-black/80 backdrop-blur-xl"
            onclick="closeLoadPresetModal(event)">
            <div class="w-full max-w-4xl mx-4 bg-white dark:bg-gradient-to-br dark:from-[#0f172a] dark:to-[#1a1f3a] border border-slate-200 dark:border-white/10 rounded-[32px] shadow-2xl modal-inner-transition transform scale-0 relative overflow-hidden"
                id="loadPresetModalInner">

                <!-- Header with gradient -->
                <div class="relative px-8 py-8 border-b border-slate-200 dark:border-white/5 bg-gradient-to-r from-amber-50 dark:from-amber-500/5 to-transparent">
                    <button onclick="closeLoadPresetModal({target:this, currentTarget:this})"
                        class="absolute top-6 right-6 w-10 h-10 rounded-xl glass hover:bg-white/10 flex items-center justify-center text-slate-400 dark:text-white/40 hover:text-slate-900 dark:hover:text-white transition">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>

                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-[16px] bg-gradient-to-br from-amber-400/20 to-amber-600/20 border border-amber-500/30 flex items-center justify-center">
                            <i class="fa-solid fa-bookmark text-amber-500 text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-[900] text-slate-900 dark:text-white uppercase italic tracking-tighter"
                                style="font-family: 'Oswald', sans-serif;">
                                MES TACTIQUES <span class="text-amber-500">(MAX 5)</span>
                            </h2>
                            <p class="text-xs text-slate-500 dark:text-white/40 font-bold uppercase tracking-[0.2em] mt-1">
                                <i class="fa-solid fa-play text-green-500 mr-1"></i>Cliquez pour charger
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Presets Grid -->
                <div class="p-8 max-h-[calc(100vh-250px)] overflow-y-auto custom-scrollbar">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="presetList">
                        <!-- Loading state -->
                        <div class="col-span-full text-center py-16">
                            <div class="inline-block">
                                <i class="fa-solid fa-spinner fa-spin text-amber-400 text-4xl mb-4 block"></i>
                                <p class="text-white/40 text-sm font-bold uppercase tracking-wider">Chargement des tactiques...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Info -->
                <div class="px-8 py-6 border-t border-slate-200 dark:border-white/5 bg-slate-50/50 dark:bg-black/20 flex items-center justify-between">
                    <p class="text-[10px] text-slate-500 dark:text-white/40 font-bold uppercase tracking-wider">
                        <i class="fa-solid fa-circle text-emerald-500 mr-2"></i>
                        <span id="presetCount">0</span> tactique(s) sauvegard√©e(s)
                    </p>
                    <button onclick="closeLoadPresetModal({target:this, currentTarget:this})"
                        class="px-6 py-2 rounded-lg glass hover:bg-white/10 text-slate-600 dark:text-white/60 hover:text-slate-900 dark:hover:text-white text-xs font-bold uppercase tracking-wider transition">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Captains Management Modal -->
<div id="captainsModal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/80 dark:bg-black/80 backdrop-blur-sm"
    onclick="closeCaptainsModal(event)">
    <div class="w-full max-w-md bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-white/10 rounded-3xl p-8 shadow-2xl modal-inner-transition transform scale-0 relative"
        id="captainsModalInner">
        <button onclick="closeCaptainsModal({target:this, currentTarget:this})"
            class="absolute top-4 right-4 text-slate-400 dark:text-white/20 hover:text-slate-900 dark:hover:text-white transition">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-3">
            <i class="fa-solid fa-copyright text-primary-400"></i>
            Gestion des Capitaines
        </h3>

        <p class="text-xs text-slate-500 dark:text-white/40 mb-6 font-bold uppercase tracking-wider">Hi√©rarchie (1 √† 5)
        </p>

        <div class="space-y-3" id="captainsSlotList">
            <!-- Captain slots will be here -->
        </div>

        <div class="mt-8 pt-6 border-t border-slate-100 dark:border-white/5">
            <button onclick="closeCaptainsModal({target:this, currentTarget:this})"
                class="w-full py-4 rounded-xl gradient-primary text-white font-bold uppercase tracking-wider hover:opacity-90 transition shadow-lg shadow-primary-500/20">
                CONFIRMER
            </button>
        </div>
    </div>
</div>

<!-- Set-Piece Takers Modal -->
<div id="takersModal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/80 dark:bg-black/80 backdrop-blur-sm"
    onclick="closeTakersModal(event)">
    <div class="w-full max-w-2xl bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-white/10 rounded-3xl p-8 shadow-2xl modal-inner-transition transform scale-0 relative h-[80vh] flex flex-col"
        id="takersModalInner">
        <button onclick="closeTakersModal({target:this, currentTarget:this})"
            class="absolute top-4 right-4 text-slate-400 dark:text-white/20 hover:text-slate-900 dark:hover:text-white transition">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-3">
            <i class="fa-solid fa-bullseye text-amber-400"></i>
            Tireurs Sp√©cialis√©s
        </h3>

        <!-- Tabs -->
        <div
            class="flex items-center gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar border-b border-slate-100 dark:border-white/5">
            <button onclick="switchTakersTab('penalties', this)"
                class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all taker-tab active"
                data-type="penalties">Penalties</button>
            <button onclick="switchTakersTab('free_kicks_direct', this)"
                class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all taker-tab"
                data-type="free_kicks_direct">CF Directs</button>
            <button onclick="switchTakersTab('free_kicks_indirect', this)"
                class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all taker-tab"
                data-type="free_kicks_indirect">CF Indirects</button>
            <button onclick="switchTakersTab('corners_left', this)"
                class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all taker-tab"
                data-type="corners_left">Corners G</button>
            <button onclick="switchTakersTab('corners_right', this)"
                class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all taker-tab"
                data-type="corners_right">Corners D</button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar pr-2" id="takersListContainer">
            <div id="takersSlotList" class="space-y-3">
                <!-- Taker slots will be here -->
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-slate-100 dark:border-white/5">
            <button onclick="closeTakersModal({target:this, currentTarget:this})"
                class="w-full py-4 rounded-xl gradient-primary text-white font-bold uppercase tracking-wider hover:opacity-90 transition shadow-lg shadow-primary-500/20">
                CONFIRMER
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" <i class="fa-solid fa-check-circle text-green-400 text-lg"></i>
    <span class="text-slate-900 dark:text-white text-sm font-bold" id="toastMessage">Sauvegard√© !</span>
</div>
</div>

<!-- Floating Help Button -->
<button onclick="startTacticalGuide()"
    class="fixed bottom-8 right-8 w-12 h-12 rounded-full gradient-primary text-white shadow-2xl z-[40] flex items-center justify-center hover:scale-110 active:scale-95 transition-all group overflow-hidden">
    <div
        class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
    </div>
    <i class="fa-solid fa-question text-lg relative z-10"></i>
</button>

<!-- Tactical Guide Overlay & Card -->
<div id="guideOverlay" class="hidden">
    <div id="guideCard" class="glass-dark p-6 rounded-3xl border border-white/10 shadow-2xl shadow-primary-500/10">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-8 h-8 rounded-full gradient-primary flex items-center justify-center text-white text-[10px] font-black"
                id="guideStepNumber">1</div>
            <h4 class="text-white font-bold" id="guideTitle">Aide Interactive</h4>
        </div>
        <p class="text-white/60 text-sm mb-6 leading-relaxed" id="guideText">
            Bienvenue ! Suivez ce court guide pour ma√Ætriser la planche tactique.
        </p>
        <div class="flex items-center justify-between">
            <button onclick="closeGuide()"
                class="text-white/40 text-xs font-bold hover:text-white transition uppercase tracking-wider">Passer</button>
            <button onclick="nextGuideStep()" id="guideNextBtn"
                class="px-6 py-2.5 rounded-xl guide-btn-next text-white text-xs font-bold uppercase tracking-wider shadow-lg shadow-primary-500/20 hover:scale-105 active:scale-95 transition">Suivant</button>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .player-card.selected {
        opacity: 0.3;
        pointer-events: none;
        border-color: rgba(255, 255, 255, 0.05) !important;
    }

    .player-card.dragging {
        opacity: 0.5;
        transform: scale(0.95);
    }

    .slot-circle.filled {
        background: white;
        color: black;
        border-style: solid;
        border-color: #000;
        border-width: 4px;
        box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.5);
        cursor: pointer;
    }

    .slot-circle.drag-over {
        border-color: rgb(34, 197, 94) !important;
        border-style: solid !important;
        background: rgba(34, 197, 94, 0.15);
        transform: scale(1.15);
        box-shadow: 0 0 25px rgba(34, 197, 94, 0.3);
    }

    .bench-card {
        animation: benchSlideIn 0.3s ease-out;
    }

    @keyframes benchSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px) scale(0.9);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    #benchArea.drag-over {
        border-color: rgba(34, 197, 94, 0.5) !important;
        background: rgba(34, 197, 94, 0.05);
    }

    /* FIFA Modal animations */
    #fifaModal.show {
        display: flex !important;
    }

    #fifaModal.show .fifa-card {
        transform: scale(1);
    }

    .fifa-stat {
        animation: fifaStatPop 0.4s ease-out backwards;
    }

    .fifa-stat:nth-child(1) {
        animation-delay: 0.1s;
    }

    .fifa-stat:nth-child(2) {
        animation-delay: 0.15s;
    }

    .fifa-stat:nth-child(3) {
        animation-delay: 0.2s;
    }

    .fifa-stat:nth-child(4) {
        animation-delay: 0.25s;
    }

    .fifa-stat:nth-child(5) {
        animation-delay: 0.3s;
    }

    .fifa-stat:nth-child(6) {
        animation-delay: 0.35s;
    }

    @keyframes fifaStatPop {
        from {
            opacity: 0;
            transform: scale(0.5);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* Toast animation */
    #toast.show {
        transform: translate(-50%, 0);
        opacity: 1;
    }

    /* Tactical config modal */
    #tacticalModal.show {
        display: flex !important;
    }

    #tacticalModal.show .tactical-modal-inner {
        transform: scale(1);
    }

    /* Responsiveness & Mobile Optimizations */
    @media (max-width: 1024px) {
        .lg\:h-\[calc\(100vh-100px\)\] {
            height: auto !important;
            min-height: 100vh;
        }

        #pitch {
            aspect-ratio: 4/5;
            min-height: 500px;
        }

        .lg\:w-96 {
            width: 100% !important;
        }
    }

    /* Smoother Overlay transitions */
    .fixed.inset-0 {
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-inner-transition {
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .glass-dark {
        background: rgba(10, 10, 15, 0.85);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .light .glass-dark {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #cbd5e1;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        color: #0f172a;
    }

    /* Pitch Dynamic Colors */
    #pitch {
        background: linear-gradient(to bottom, #064e3b, #065f46);
        /* Dark: Emerald */
        transition: background 0.5s ease;
    }

    .light #pitch {
        background: linear-gradient(to bottom, #15803d, #16a34a);
        /* Light: Grass Green */
    }

    #pitch svg line,
    #pitch svg rect,
    #pitch svg circle {
        stroke: rgba(255, 255, 255, 0.3);
    }

    .light #pitch svg line,
    .light #pitch svg rect,
    .light #pitch svg circle {
        stroke: rgba(255, 255, 255, 0.5);
    }

    /* FIFA Style Tactic Buttons */
    .tactic-btn {
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.6);
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .light .tactic-btn {
        background: #ffffff;
        border-color: #e2e8f0;
        color: #64748b;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .tactic-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
    }

    .tactic-btn:hover::before {
        transform: translateX(100%);
    }

    .tactic-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }

    .light .tactic-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #0f172a;
    }

    .tactic-btn.active {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
        border-color: rgba(245, 158, 11, 0.8);
        color: rgb(255, 255, 255);
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.15), inset 0 0 10px rgba(245, 158, 11, 0.1);
    }

    .light .tactic-btn.active {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
        color: #0f172a;
    }

    .tactic-btn.active .tactic-btn-icon {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }

    /* Guide Card Visibility in Light Mode */
    .light #guideCard {
        background: rgba(255, 255, 255, 0.98);
        border: 1px solid #cbd5e1;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .light #guideTitle {
        color: #0f172a;
    }

    .light #guideText {
        color: #64748b;
    }

    .light #guideCard button:first-child {
        color: #94a3b8;
    }

    .light #guideCard button:first-child:hover {
        color: #0f172a;
    }

    .tactic-btn-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Counter Pressing Toggle specific styles */
    #cpToggleBg.on {
        background: #f59e0b;
        border-color: #f59e0b;
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
    }

    #cpToggleDot.on {
        left: calc(100% - 28px);
        background: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transform: scale(1.1);
    }

    /* Summary items anim */
    .summary-item {
        animation: summarySlideIn 0.4s ease-out backwards;
        position: relative;
        padding-left: 12px;
    }

    .summary-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 4px;
        background: #f59e0b;
        border-radius: 50%;
    }

    @keyframes summarySlideIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .taker-tab {
        color: rgba(148, 163, 184, 0.5);
        /* slate-400 with 0.5 opacity */
        border: 1px solid transparent;
    }

    .dark .taker-tab {
        color: rgba(255, 255, 255, 0.3);
        /* white/30 */
    }

    .taker-tab.active {
        background: rgba(245, 158, 11, 0.1);
        /* amber-500/10 */
        color: #f59e0b;
        /* amber-500 */
        border-color: rgba(245, 158, 11, 0.3);
    }

    /* Guide / Focus Mode Styles */
    #guideOverlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.7);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    #guideOverlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .guide-focus {
        position: relative;
        z-index: 10000 !important;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 40px rgba(245, 158, 11, 0.5);
        pointer-events: auto !important;
        transition: all 0.5s ease;
    }

    #guideCard {
        position: absolute;
        z-index: 10001;
        width: 320px;
        pointer-events: auto;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    #guideCard.active {
        opacity: 1;
        transform: translateY(0);
    }

    .guide-btn-next {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    /* ============================================================
       PHASE 1: DRAG & DROP ENHANCEMENTS
       ============================================================ */

    /* Smooth GPU-accelerated animations */
    .player-card {
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.2s ease,
            box-shadow 0.2s ease;
        will-change: transform;
        position: relative;
    }

    .player-card.dragging {
        opacity: 0.6;
        transform: scale(0.95) rotate(2deg);
        cursor: grabbing !important;
        z-index: 1000;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4) !important;
    }

    .player-card.drag-ghost {
        opacity: 0.3;
        transform: scale(0.9);
    }

    /* Zone highlighting pendant drag */
    .pitch-area.drag-active {
        background: radial-gradient(circle at 50% 50%,
                rgba(var(--primary-rgb, 16 185 129), 0.1) 0%,
                transparent 60%) !important;
        box-shadow: inset 0 0 60px rgba(var(--primary-rgb, 16 185 129), 0.2) !important;
    }

    #benchArea.drag-active {
        border-color: rgb(var(--primary-rgb, 16 185 129)) !important;
        box-shadow: 0 0 40px rgba(var(--primary-rgb, 16 185 129), 0.3) !important;
    }

    /* Animation de drop */
    @keyframes dropPulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
        }
    }

    .just-dropped {
        animation: dropPulse 0.3s ease;
    }

    /* Snap-to-grid effect pour les positions */
    .slot-circle.drag-over {
        transform: scale(1.1) !important;
        box-shadow: 0 0 30px rgba(var(--primary-rgb, 16 185 129), 0.6) !important;
    }

    /* ============================================================
       PHASE 1: FIFA-STYLE PLAYER CARDS
       ============================================================ */

    /* Rating tiers avec gradients dynamiques */
    .player-card.rating-gold {
        background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 50%, #b45309 100%);
        border: 2px solid #fbbf24;
        box-shadow: 0 8px 32px rgba(251, 191, 36, 0.3);
    }

    .player-card.rating-silver {
        background: linear-gradient(135deg, #f3f4f6 0%, #d1d5db 50%, #9ca3af 100%);
        border: 2px solid #e5e7eb;
    }

    .player-card.rating-bronze {
        background: linear-gradient(135deg, #fdba74 0%, #f97316 50%, #c2410c 100%);
        border: 2px solid #fb923c;
    }

    .player-card.rating-common {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        border: 2px solid #475569;
    }

    /* Light mode adjustments */
    .light .player-card.rating-gold {
        background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
        border: 2px solid #d97706;
        box-shadow: 0 8px 32px rgba(217, 119, 6, 0.2);
    }

    .light .player-card.rating-silver {
        background: linear-gradient(135deg, #ffffff 0%, #e5e7eb 100%);
        border: 2px solid #cbd5e1;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .light .player-card.rating-bronze {
        background: linear-gradient(135deg, #fef08a 0%, #fbbf24 100%);
        border: 2px solid #f59e0b;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    /* Holographic shine effect on hover */
    @keyframes shine {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }

    .player-card:hover::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%);
        animation: shine 1.5s ease infinite;
        pointer-events: none;
        border-radius: 0.75rem;
    }

    /* Rating badge enhancement */
    .rating-badge {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .light .rating-badge {
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* ============================================================
       PHASE 1: PITCH STYLING ENHANCEMENTS
       ============================================================ */

    #pitch {
        background:
            linear-gradient(90deg, transparent 49.5%, rgba(255, 255, 255, 0.1) 49.5%, rgba(255, 255, 255, 0.1) 50.5%, transparent 50.5%),
            linear-gradient(0deg, transparent 32.8%, rgba(255, 255, 255, 0.08) 32.8%, rgba(255, 255, 255, 0.08) 33.2%, transparent 33.2%),
            linear-gradient(0deg, transparent 66.3%, rgba(255, 255, 255, 0.08) 66.3%, rgba(255, 255, 255, 0.08) 66.7%, transparent 66.7%),
            linear-gradient(135deg, #047857 0%, #059669 50%, #10b981 100%) !important;
        position: relative;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: inset 0 0 80px rgba(0, 0, 0, 0.3);
        background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%;
    }

    .light #pitch {
        background:
            linear-gradient(90deg, transparent 49.5%, rgba(0, 0, 0, 0.08) 49.5%, rgba(0, 0, 0, 0.08) 50.5%, transparent 50.5%),
            linear-gradient(0deg, transparent 32.8%, rgba(0, 0, 0, 0.06) 32.8%, rgba(0, 0, 0, 0.06) 33.2%, transparent 33.2%),
            linear-gradient(0deg, transparent 66.3%, rgba(0, 0, 0, 0.06) 66.3%, rgba(0, 0, 0, 0.06) 66.7%, transparent 66.7%),
            linear-gradient(135deg, #86efac 0%, #6ee7b7 50%, #5eead4 100%) !important;
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.1);
    }

    /* Position slots enhancement */
    .slot-circle {
        background: rgba(255, 255, 255, 0.05);
        border: 2px dashed rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(4px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }

    .light .slot-circle {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(0, 0, 0, 0.2);
    }

    .slot-circle:hover {
        transform: scale(1.05);
        border-color: rgb(var(--primary-rgb, 16 185 129));
        background: rgba(var(--primary-rgb, 16 185 129), 0.1);
    }

    .slot-circle.filled {
        background: white;
        border: 2px solid rgb(var(--primary-rgb, 16 185 129));
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .light .slot-circle.filled {
        background: #ffffff;
        border-color: rgb(var(--primary-rgb, 16 185 129));
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* ============================================================
       PHASE 1: DARK/LIGHT MODE TRANSITIONS
       ============================================================ */

    /* Smooth theme transition */
    * {
        transition: background-color 0.3s ease,
            border-color 0.3s ease,
            color 0.3s ease;
    }

    /* Prevent transition on page load */
    .preload * {
        transition: none !important;
    }

    /* ============================================================
       PHASE 2: TACTIQUE ULTIMATE ANALYTICS STYLES
       ============================================================ */

    /* Analytics Tab Navigation */
    .analytics-tab {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.6);
    }

    .analytics-tab:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.8);
    }

    .analytics-tab.active {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
        border-color: rgba(99, 102, 241, 0.5);
        color: #818cf8;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
    }

    .light .analytics-tab {
        background: #f8fafc;
        border-color: #e2e8f0;
        color: #64748b;
    }

    .light .analytics-tab:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #334155;
    }

    .light .analytics-tab.active {
        background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        border-color: #a5b4fc;
        color: #4f46e5;
    }

    /* Analytics Content Animation */
    .analytics-content {
        animation: fadeInContent 0.3s ease;
    }

    @keyframes fadeInContent {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Gradient Animation for Metrics */
    @keyframes gradientShift {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }

    /* Glow effect on hover for metric cards */
    .glass-dark {
        transition: all 0.3s ease;
    }

    /* Light mode adjustments for analytics */
    .light .glass-dark {
        background: rgba(255, 255, 255, 0.95);
        border-color: #e2e8f0;
    }

    /* ============================================================
       SIMPLE SAVE/LOAD TACTIQUE CARDS
       ============================================================ */

    /* Tactique Card Base */
    .tactique-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 24px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        animation: slideInCard 0.4s ease-out backwards;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    @keyframes slideInCard {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
        to {
            opacity: 0;
            transform: translateX(-20px) scale(0.9);
        }
    }

    .tactique-card:nth-child(1) { animation-delay: 0.1s; }
    .tactique-card:nth-child(2) { animation-delay: 0.15s; }
    .tactique-card:nth-child(3) { animation-delay: 0.2s; }
    .tactique-card:nth-child(4) { animation-delay: 0.25s; }
    .tactique-card:nth-child(5) { animation-delay: 0.3s; }

    .tactique-card:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.05) 100%);
        border-color: rgba(251, 191, 36, 0.5);
        box-shadow: 0 0 40px rgba(251, 191, 36, 0.15), 0 8px 32px rgba(0, 0, 0, 0.2);
        transform: translateY(-4px);
    }

    .tactique-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .tactique-card:hover::before {
        opacity: 1;
    }

    /* Light mode card */
    .light .tactique-card {
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.8) 100%);
        border-color: #e2e8f0;
    }

    .light .tactique-card:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
        border-color: #d97706;
        box-shadow: 0 0 30px rgba(217, 119, 6, 0.1), 0 8px 32px rgba(0, 0, 0, 0.05);
    }

    /* Formation Badge */
    .formation-badge {
        display: inline-block;
        padding: 6px 16px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #000;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        width: fit-content;
    }

    .light .formation-badge {
        box-shadow: 0 2px 8px rgba(217, 119, 6, 0.2);
    }

    /* Load Button Animation */
    @keyframes loadingPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .tactique-card.loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Action Buttons */
    .tactique-action-btn {
        padding: 10px 16px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .tactique-load-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        flex: 1;
    }

    .tactique-load-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .tactique-load-btn:active {
        transform: translateY(0);
    }

    .tactique-delete-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
        padding: 8px 12px;
    }

    .tactique-delete-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.5);
    }

    /* Light mode buttons */
    .light .tactique-delete-btn {
        background: rgba(239, 68, 68, 0.08);
        border-color: rgba(239, 68, 68, 0.25);
        color: #dc2626;
    }

    .light .tactique-delete-btn:hover {
        background: rgba(239, 68, 68, 0.15);
    }

    /* Success Animation */
    @keyframes successPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.08); }
        100% { transform: scale(1); }
    }

    .tactique-card.success {
        border-color: #10b981;
        animation: successPulse 0.5s ease;
    }

    .light .tactique-card.success {
        border-color: #059669;
    }

    /* ============================================================
       PHASE 4: VISUALISEUR TACTIQUE STYLES
       ============================================================ */

    /* Visualiser Tab Navigation */
    .visualiser-tab {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.6);
    }

    .visualiser-tab:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.8);
    }

    .visualiser-tab.active {
        background: linear-gradient(135deg, rgba(244, 63, 94, 0.15) 0%, rgba(236, 72, 153, 0.15) 100%);
        border-color: rgba(244, 63, 94, 0.5);
        color: #f43f5e;
        box-shadow: 0 0 20px rgba(244, 63, 94, 0.2);
    }

    .light .visualiser-tab {
        background: #f8fafc;
        border-color: #e2e8f0;
        color: #64748b;
    }

    .light .visualiser-tab.active {
        background: linear-gradient(135deg, #ffe4e6 0%, #fbecf3 100%);
        border-color: #f43f5e;
        color: #be123c;
    }

    /* Visualiser Content Animation */
    .visualiser-content {
        animation: fadeInContent 0.3s ease;
    }

    /* Phase Buttons */
    .phase-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .phase-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.8);
    }

    .phase-btn.active {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
        border-color: rgba(99, 102, 241, 0.5);
        color: #818cf8;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
    }

    .phase-btn[data-phase="defense"].active {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.15) 100%);
        border-color: rgba(59, 130, 246, 0.5);
        color: #3b82f6;
    }

    .phase-btn[data-phase="transition"].active {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
        border-color: rgba(168, 85, 247, 0.5);
        color: #a855f7;
    }

    .phase-btn[data-phase="attack"].active {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
        border-color: rgba(239, 68, 68, 0.5);
        color: #ef4444;
    }

    /* Light mode phase buttons */
    .light .phase-btn {
        background: #f8fafc;
        border-color: #e2e8f0;
        color: #64748b;
    }

    .light .phase-btn.active {
        background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        border-color: #818cf8;
        color: #4f46e5;
    }

</style>

<!-- FIFA Player Card Modal -->
<div id="fifaModal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/90 backdrop-blur-xl"
    onclick="closeFifaModal(event)">
    <div id="fifaCardInner"
        class="relative w-full max-w-4xl mx-4 transform scale-0 transition-transform duration-500 ease-out flex flex-col md:flex-row gap-8 items-center justify-center pointer-events-none">

        <!-- The Card -->
        <div
            class="relative w-[320px] h-[480px] bg-gradient-to-b from-[#fcd34d] via-[#fbbf24] to-[#b45309] rounded-[2rem] shadow-[0_0_100px_rgba(245,158,11,0.6)] p-1 pointer-events-auto border-2 border-[#fff7ed]">
            <!-- Inner Border -->
            <div
                class="w-full h-full rounded-[1.8rem] border border-[#78350f] bg-gradient-to-b from-[#1c1917] to-[#451a03] overflow-hidden relative">

                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-20"
                    style="background-image: radial-gradient(circle at 10px 10px, rgba(255,255,255,0.2) 2px, transparent 0); background-size: 30px 30px;">
                </div>

                <!-- Top Info -->
                <div class="absolute top-8 left-8 flex flex-col items-center z-10">
                    <span id="fifaOverall" class="text-6xl font-[900] text-white drop-shadow-md tracking-tighter"
                        style="font-family: 'Oswald', sans-serif;">88</span>
                    <span id="fifaPosition" class="text-2xl font-bold text-white/90 uppercase mt-[-5px]">CM</span>
                    <div class="w-10 h-[1px] bg-white/30 my-2"></div>
                    <div class="flex flex-col items-center">
                        <img src="{{ url_for('static', filename='img/club_logo.png') }}" class="w-8 h-8 object-contain"
                            alt="Club" onerror="this.style.display='none'">
                        <!-- <span class="text-[10px] uppercase font-bold text-white/50 mt-1">CLUB</span> -->
                    </div>
                </div>

                <!-- Player Image (Placeholder if none) -->
                <div class="absolute top-[60px] right-[-20px] w-[220px] h-[220px]">
                    <img id="fifaFace" src="{{ url_for('static', filename='img/default_player.png') }}"
                        class="w-full h-full object-contain drop-shadow-[0_10px_20px_rgba(0,0,0,0.5)]" alt="Player">
                </div>

                <!-- Name & Stats -->
                <div
                    class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-black/0 pt-20 pb-6 px-6 flex flex-col items-center">
                    <h2 id="fifaName"
                        class="text-3xl font-[900] text-white uppercase tracking-tighter mb-4 drop-shadow-lg text-center leading-none">
                        MBAPPE</h2>
                    <div class="w-full h-[2px] bg-gradient-to-r from-transparent via-[#fcd34d] to-transparent mb-4">
                    </div>

                    <div class="grid grid-cols-2 gap-x-8 gap-y-1 w-full px-2">
                        <div class="flex items-center justify-between fifa-stat">
                            <span class="text-white/60 font-bold uppercase text-sm tracking-wider">VIT</span>
                            <span id="fifaVIT" class="text-xl font-[900] text-white">97</span>
                        </div>
                        <div class="flex items-center justify-between fifa-stat">
                            <span class="text-white/60 font-bold uppercase text-sm tracking-wider">DRI</span>
                            <span id="fifaDRI" class="text-xl font-[900] text-white">92</span>
                        </div>
                        <div class="flex items-center justify-between fifa-stat">
                            <span class="text-white/60 font-bold uppercase text-sm tracking-wider">TIR</span>
                            <span id="fifaTIR" class="text-xl font-[900] text-white">89</span>
                        </div>
                        <div class="flex items-center justify-between fifa-stat">
                            <span class="text-white/60 font-bold uppercase text-sm tracking-wider">DEF</span>
                            <span id="fifaDEF" class="text-xl font-[900] text-white">36</span>
                        </div>
                        <div class="flex items-center justify-between fifa-stat">
                            <span class="text-white/60 font-bold uppercase text-sm tracking-wider">PAS</span>
                            <span id="fifaPAS" class="text-xl font-[900] text-white">80</span>
                        </div>
                        <div class="flex items-center justify-between fifa-stat">
                            <span class="text-white/60 font-bold uppercase text-sm tracking-wider">PHY</span>
                            <span id="fifaPHY" class="text-xl font-[900] text-white">76</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="pointer-events-auto flex flex-col gap-4">
            <div class="glass-dark p-6 rounded-3xl border border-white/10 w-[300px]">
                <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-amber-500"></i> Instructions
                </h3>
                <div class="space-y-3">
                    <div class="text-white/60 text-sm">R√¥le: <span class="text-white font-bold ml-1">Libre</span></div>
                    <div class="text-white/60 text-sm">Courses: <span class="text-white font-bold ml-1">Dans le
                            dos</span></div>
                    <div class="text-white/60 text-sm">Interceptions: <span
                            class="text-white font-bold ml-1">Normales</span></div>
                </div>
                <button onclick="closeFifaModal()"
                    class="mt-6 w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 text-white font-bold transition">Fermer</button>
            </div>
        </div>

    </div>
</div>

<script>
    // ============================================================
    // STATE
    // ============================================================
    const pitchArea = document.getElementById('pitchArea');
    const slotTemplate = document.getElementById('playerSlotTemplate');
    const configEl = document.getElementById('tactics-config');
    const starters = JSON.parse(configEl.getAttribute('data-starters'));
    const savedSubstitutes = JSON.parse(configEl.getAttribute('data-substitutes'));
    const initialFormation = configEl.getAttribute('data-formation');

    let activeSlot = null;
    let assignment = { ...starters };
    let substitutes = [...savedSubstitutes];
    let captains = JSON.parse(configEl.getAttribute('data-captains') || '[]');
    let setPieces = JSON.parse(configEl.getAttribute('data-set-pieces') || '{}');
    let draggedPlayerId = null;
    let draggedFromSlot = null;
    let draggedFromBench = false;
    let currentModalPlayerId = null;
    let currentModalSlotPos = null;

    // ============================================================
    // AUTO-SAVE LOGIC
    // ============================================================
    let autoSaveTimeout;
    function triggerAutoSave() {
        const status = document.getElementById('autoSaveStatus');
        const name = document.getElementById('tacticNameInput').value;

        if (!name) {
            status.textContent = '';
            status.className = 'absolute -bottom-6 right-2 text-[9px] font-bold uppercase tracking-widest transition-all text-white/10';
            return;
        }

        status.textContent = 'Modifications...';
        status.className = 'absolute -bottom-6 right-2 text-[9px] font-bold uppercase tracking-widest transition-all text-amber-500/50';

        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            status.textContent = 'Sauvegarde...';

            const formation = document.getElementById('formationSelect').value;

            fetch('/coach/tactics/preset/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    team_id: '{{ selected_team_id }}',
                    name: name,
                    description: '',
                    formation: formation,
                    starters: assignment,
                    substitutes: substitutes,
                    instructions: tacticalConfig,
                    captains: captains,
                    set_pieces: setPieces
                })
            })
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(() => {
                    status.textContent = 'Enregistr√© ‚úì';
                    status.className = 'absolute -bottom-6 right-2 text-[9px] font-bold uppercase tracking-widest transition-all text-green-400';
                    setTimeout(() => {
                        if (status.textContent.startsWith('Enregistr√©')) {
                            status.className = 'absolute -bottom-6 right-2 text-[9px] font-bold uppercase tracking-widest transition-all text-white/5';
                        }
                    }, 3000);
                })
                .catch(err => {
                    console.error('AutoSave failed:', err);
                    status.textContent = '‚ö† Erreur auto-save';
                    status.className = 'absolute -bottom-6 right-2 text-[9px] font-bold uppercase tracking-widest transition-all text-red-400';
                });
        }, 2000);
    }

    // ============================================================
    // CAPTAINS & TAKERS LOGIC
    // ============================================================
    let currentTakersType = 'penalties';

    function openCaptainsModal() {
        const modal = document.getElementById('captainsModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            document.getElementById('captainsModalInner').style.transform = 'scale(1)';
        }, 10);
        renderCaptainsSlots();
    }

    function closeCaptainsModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('captainsModalInner').style.transform = 'scale(0)';
        setTimeout(() => {
            const modal = document.getElementById('captainsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
        updateFormation(); // Refresh pitch to update (C) indicator
    }

    function renderCaptainsSlots() {
        const list = document.getElementById('captainsSlotList');
        list.innerHTML = '';

        // We allow up to 5 captains
        for (let i = 0; i < 5; i++) {
            const playerId = captains[i];
            const player = playerId ? playerData[playerId] : null;

            const el = document.createElement('div');
            el.className = 'glass p-4 rounded-xl border border-slate-200 dark:border-white/5 flex items-center justify-between group';

            if (player) {
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-primary-500/20 flex items-center justify-center text-primary-400 text-xs font-bold">
                            ${i + 1}
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-900 dark:text-white">${player.name}</p>
                            <p class="text-[10px] text-slate-500 dark:text-white/40 uppercase tracking-tighter">${player.position} #${player.jersey_number}</p>
                        </div>
                    </div>
                    <button onclick="removeCaptain(${i})" class="w-8 h-8 rounded-lg bg-red-500/10 text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
            } else {
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-white/5 flex items-center justify-center text-slate-400 dark:text-white/20 text-xs font-bold">
                            ${i + 1}
                        </div>
                        <select onchange="assignCaptain(${i}, this.value)" class="bg-transparent text-slate-400 dark:text-white/20 text-[10px] font-bold uppercase tracking-wider border-none focus:ring-0 cursor-pointer">
                            <option value="">+ ASSIGNER</option>
                            ${Object.values(assignment).filter(id => id && !captains.includes(id)).map(id => `
                                <option value="${id}" class="bg-slate-900">${playerData[id].name}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            list.appendChild(el);
        }
    }

    function assignCaptain(index, playerId) {
        if (!playerId) return;
        captains[index] = playerId;
        renderCaptainsSlots();
        updateFormation();
        triggerAutoSave();
    }

    function removeCaptain(index) {
        captains.splice(index, 1);
        renderCaptainsSlots();
        updateFormation();
        triggerAutoSave();
    }

    function openTakersModal() {
        const modal = document.getElementById('takersModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            document.getElementById('takersModalInner').style.transform = 'scale(1)';
        }, 10);
        renderTakersSlots();
    }

    function closeTakersModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('takersModalInner').style.transform = 'scale(0)';
        setTimeout(() => {
            const modal = document.getElementById('takersModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    function switchTakersTab(type, btn) {
        currentTakersType = type;
        document.querySelectorAll('.taker-tab').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        else {
            const activeBtn = document.querySelector(`.taker-tab[data-type="${type}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }
        renderTakersSlots();
    }

    function renderTakersSlots() {
        const list = document.getElementById('takersSlotList');
        list.innerHTML = '';

        const typeTakers = setPieces[currentTakersType] || [];

        // Show up to 3 priority levels for takers
        for (let i = 0; i < 3; i++) {
            const playerId = typeTakers[i];
            const player = playerId ? playerData[playerId] : null;

            const el = document.createElement('div');
            el.className = 'glass p-4 rounded-xl border border-slate-200 dark:border-white/5 flex items-center justify-between group';

            if (player) {
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center text-amber-400 text-xs font-bold">
                            ${i + 1}
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-900 dark:text-white">${player.name}</p>
                            <p class="text-[10px] text-slate-500 dark:text-white/40 uppercase tracking-tighter">${player.position} #${player.jersey_number}</p>
                        </div>
                    </div>
                    <button onclick="removeTaker(${i})" class="w-8 h-8 rounded-lg bg-red-500/10 text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
            } else {
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-white/5 flex items-center justify-center text-slate-400 dark:text-white/20 text-xs font-bold">
                            ${i + 1}
                        </div>
                        <select onchange="assignTaker(${i}, this.value)" class="bg-transparent text-slate-400 dark:text-white/20 text-[10px] font-bold uppercase tracking-wider border-none focus:ring-0 cursor-pointer">
                            <option value="">+ ASSIGNER</option>
                            ${Object.values(assignment).filter(id => id && !typeTakers.includes(id)).map(id => `
                                <option value="${id}" class="bg-slate-900">${playerData[id].name}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            list.appendChild(el);
        }
    }

    function assignTaker(index, playerId) {
        if (!playerId) return;
        if (!setPieces[currentTakersType]) setPieces[currentTakersType] = [];
        setPieces[currentTakersType][index] = playerId;
        renderTakersSlots();
        triggerAutoSave();
    }

    function removeTaker(index) {
        if (setPieces[currentTakersType]) {
            setPieces[currentTakersType].splice(index, 1);
        }
        renderTakersSlots();
        triggerAutoSave();
    }

    // Player data lookup
    const playerData = {};
    document.querySelectorAll('.player-card').forEach(card => {
        const id = card.getAttribute('data-player-id');
        playerData[id] = {
            id,
            name: card.getAttribute('data-player-name'),
            number: card.getAttribute('data-player-number'),
            position: card.getAttribute('data-player-pos'),
            vit: parseInt(card.getAttribute('data-player-vit')) || 50,
            tir: parseInt(card.getAttribute('data-player-tir')) || 50,
            pas: parseInt(card.getAttribute('data-player-pas')) || 50,
            dri: parseInt(card.getAttribute('data-player-dri')) || 50,
            def: parseInt(card.getAttribute('data-player-def')) || 50,
            phy: parseInt(card.getAttribute('data-player-phy')) || 50,
        };
    });

    // ============================================================
    // PHASE 1: FIFA-STYLE RATING-BASED CARD STYLING
    // ============================================================
    function applyRatingStyles() {
        document.querySelectorAll('.player-card').forEach(card => {
            const ovr = parseInt(card.getAttribute('data-overall') || 50);

            // Remove all rating classes first
            card.classList.remove('rating-gold', 'rating-silver', 'rating-bronze', 'rating-common');

            // Apply rating-based class
            if (ovr >= 85) {
                card.classList.add('rating-gold');
            } else if (ovr >= 75) {
                card.classList.add('rating-silver');
            } else if (ovr >= 65) {
                card.classList.add('rating-bronze');
            } else {
                card.classList.add('rating-common');
            }
        });
    }

    // Apply rating styles on page load
    document.addEventListener('DOMContentLoaded', applyRatingStyles);
    // Also apply immediately in case DOM is ready
    applyRatingStyles();

    // ============================================================
    // FORMATIONS
    // ============================================================
    const formations = {
        '4-3-3': {
            'GK': [50, 85], 'LB': [15, 65], 'CB1': [38, 70], 'CB2': [62, 70], 'RB': [85, 65],
            'CDM': [50, 55], 'CM1': [30, 45], 'CM2': [70, 45],
            'LW': [20, 25], 'ST': [50, 15], 'RW': [80, 25]
        },
        '4-4-2': {
            'GK': [50, 85], 'LB': [15, 70], 'CB1': [38, 72], 'CB2': [62, 72], 'RB': [85, 70],
            'LM': [15, 45], 'CM1': [38, 48], 'CM2': [62, 48], 'RM': [85, 45],
            'ST1': [40, 20], 'ST2': [60, 20]
        },
        '3-5-2': {
            'GK': [50, 85], 'CB1': [25, 70], 'CB2': [50, 72], 'CB3': [75, 70],
            'LWB': [10, 50], 'RWB': [90, 50], 'CDM': [50, 58], 'CM1': [35, 45], 'CM2': [65, 45],
            'ST1': [40, 20], 'ST2': [60, 20]
        },
        '4-2-3-1': {
            'GK': [50, 85], 'LB': [15, 70], 'CB1': [38, 72], 'CB2': [62, 72], 'RB': [85, 70],
            'CDM1': [40, 55], 'CDM2': [60, 55], 'LAM': [25, 35], 'CAM': [50, 35], 'RAM': [75, 35],
            'ST': [50, 15]
        },
        // Phase 1: 6 nouvelles formations populaires FIFA
        '5-3-2': {
            'GK': [50, 85],
            'LWB': [10, 70], 'LCB': [30, 75], 'CB': [50, 75], 'RCB': [70, 75], 'RWB': [90, 70],
            'LCM': [30, 50], 'CM': [50, 50], 'RCM': [70, 50],
            'LS': [40, 20], 'RS': [60, 20]
        },
        '4-1-2-1-2': {
            'GK': [50, 85],
            'LB': [15, 65], 'LCB': [35, 75], 'RCB': [65, 75], 'RB': [85, 65],
            'CDM': [50, 60],
            'LCM': [35, 45], 'RCM': [65, 45],
            'CAM': [50, 30],
            'LS': [40, 15], 'RS': [60, 15]
        },
        '4-3-2-1': {
            'GK': [50, 85],
            'LB': [15, 65], 'LCB': [35, 75], 'RCB': [65, 75], 'RB': [85, 65],
            'LCM': [30, 50], 'CM': [50, 55], 'RCM': [70, 50],
            'LF': [35, 25], 'RF': [65, 25],
            'ST': [50, 15]
        },
        '3-4-3': {
            'GK': [50, 85],
            'LCB': [25, 75], 'CB': [50, 75], 'RCB': [75, 75],
            'LM': [10, 50], 'LCM': [35, 50], 'RCM': [65, 50], 'RM': [90, 50],
            'LW': [25, 20], 'ST': [50, 15], 'RW': [75, 20]
        },
        '4-5-1': {
            'GK': [50, 85],
            'LB': [15, 65], 'LCB': [35, 75], 'RCB': [65, 75], 'RB': [85, 65],
            'LM': [15, 45], 'LCM': [35, 50], 'CM': [50, 50], 'RCM': [65, 50], 'RM': [85, 45],
            'ST': [50, 15]
        },
        '5-4-1': {
            'GK': [50, 85],
            'LWB': [10, 65], 'LCB': [30, 75], 'CB': [50, 75], 'RCB': [70, 75], 'RWB': [90, 65],
            'LCM': [30, 50], 'LDM': [40, 55], 'RDM': [60, 55], 'RCM': [70, 50],
            'ST': [50, 15]
        }
    };

    // ============================================================
    // DRAG & DROP
    // ============================================================
    function onDragStart(e, el) {
        draggedPlayerId = el.getAttribute('data-player-id');
        draggedFromSlot = null;
        draggedFromBench = false;
        el.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedPlayerId);
    }

    function onDragEnd(e) {
        e.target.classList.remove('dragging');
        draggedPlayerId = null;
        draggedFromSlot = null;
        draggedFromBench = false;
        document.querySelectorAll('.slot-circle.drag-over').forEach(s => s.classList.remove('drag-over'));
        document.getElementById('benchArea').classList.remove('drag-over');
    }

    function onDragStartFromSlot(e, slotEl) {
        const pos = slotEl.closest('[data-pos]').getAttribute('data-pos');
        draggedPlayerId = assignment[pos];
        draggedFromSlot = pos;
        draggedFromBench = false;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedPlayerId);
    }

    function onDragStartFromBench(e, benchCard) {
        draggedPlayerId = benchCard.getAttribute('data-player-id');
        draggedFromSlot = null;
        draggedFromBench = true;
        benchCard.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedPlayerId);
    }

    function onDragOverSlot(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }

    function onDragLeaveSlot(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function onDropSlot(e, slotCircle) {
        e.preventDefault();
        e.stopPropagation();
        slotCircle.classList.remove('drag-over');

        const playerId = e.dataTransfer.getData('text/plain') || draggedPlayerId;
        if (!playerId || !playerData[playerId]) return;

        const slotContainer = slotCircle.closest('[data-pos]');
        const pos = slotContainer.getAttribute('data-pos');

        // If dragged from another slot, clear that slot
        if (draggedFromSlot && draggedFromSlot !== pos) {
            // Swap: if target slot has a player, move them to the source slot
            const existingPlayer = assignment[pos];
            if (existingPlayer) {
                assignment[draggedFromSlot] = existingPlayer;
                const srcSlot = document.querySelector(`[data-pos="${draggedFromSlot}"]`);
                if (srcSlot) {
                    const p = playerData[existingPlayer];
                    fillSlot(srcSlot, p);
                }
            } else {
                clearSlot(draggedFromSlot);
            }
        }

        // If dragged from bench, remove from bench
        if (draggedFromBench) {
            substitutes = substitutes.filter(id => id !== playerId);
            renderBench();
        }

        // If there was already a player in this slot (and not swapping), free them
        const oldPlayer = assignment[pos];
        if (oldPlayer && oldPlayer !== playerId && !draggedFromSlot) {
            const oldCard = document.querySelector(`.player-card[data-player-id="${oldPlayer}"]`);
            if (oldCard) oldCard.classList.remove('selected');
        }

        assignment[pos] = playerId;
        fillSlot(slotContainer, playerData[playerId]);
        markPlayerSelected(playerId);

        triggerAutoSave();

        draggedPlayerId = null;
        draggedFromSlot = null;
        draggedFromBench = false;
    }

    function onDragOverPitch(e) {
        e.preventDefault();
    }

    function onDropPitch(e) {
        e.preventDefault();
        // Only handle if not dropped on a specific slot (that's handled by onDropSlot)
    }

    function onDragOverBench(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        document.getElementById('benchArea').classList.add('drag-over');
    }

    function onDragLeaveBench(e) {
        if (!e.currentTarget.contains(e.relatedTarget)) {
            document.getElementById('benchArea').classList.remove('drag-over');
        }
    }

    function onDropBench(e) {
        e.preventDefault();
        document.getElementById('benchArea').classList.remove('drag-over');

        const playerId = e.dataTransfer.getData('text/plain') || draggedPlayerId;
        if (!playerId || !playerData[playerId]) return;

        // If already on bench, ignore
        if (substitutes.includes(playerId) && !draggedFromSlot) return;

        // If dragged from a pitch slot, clear the slot
        if (draggedFromSlot) {
            clearSlot(draggedFromSlot);
        }

        // Remove from starters if assigned anywhere
        Object.keys(assignment).forEach(pos => {
            if (assignment[pos] === playerId) {
                clearSlot(pos);
            }
        });

        // Add to bench
        if (!substitutes.includes(playerId)) {
            substitutes.push(playerId);
        }
        markPlayerSelected(playerId);
        renderBench();
        triggerAutoSave();

        draggedPlayerId = null;
        draggedFromSlot = null;
        draggedFromBench = false;
    }

    // ============================================================
    // PITCH RENDERING
    // ============================================================
    function updateFormation() {
        const formation = document.getElementById('formationSelect').value;
        const config = formations[formation] || formations['4-3-3'];

        triggerAutoSave();
        // Phase 2: Update tactical metrics when formation changes
        calculateTacticalMetrics();

        // Clear unmatched assignments
        const validPositions = Object.keys(config);
        Object.keys(assignment).forEach(pos => {
            if (!validPositions.includes(pos)) {
                const playerId = assignment[pos];
                if (playerId) {
                    const card = document.querySelector(`.player-card[data-player-id="${playerId}"]`);
                    if (card) card.classList.remove('selected');
                }
                delete assignment[pos];
            }
        });

        pitchArea.innerHTML = '';
        Object.entries(config).forEach(([pos, coords]) => {
            const clone = slotTemplate.content.cloneNode(true);
            const container = clone.querySelector('div');
            container.style.left = coords[0] + '%';
            container.style.top = coords[1] + '%';
            container.style.transform = 'translate(-50%, -50%)';
            container.setAttribute('data-pos', pos);
            container.onclick = (e) => handleSlotClick(e, container);

            const slotCircle = clone.querySelector('.slot-circle');
            slotCircle.addEventListener('dragleave', onDragLeaveSlot);

            const nameEl = clone.querySelector('.slot-name');
            nameEl.innerText = pos;

            // Restore assigned player
            if (assignment[pos]) {
                const p = playerData[assignment[pos]];
                if (p) {
                    fillSlot(container, p);
                    markPlayerSelected(p.id);
                }
            }

            pitchArea.appendChild(clone);
        });
    }

    function handleSlotClick(e, container) {
        const pos = container.getAttribute('data-pos');
        const playerId = assignment[pos];

        // If slot has a player, show FIFA modal
        if (playerId && playerData[playerId]) {
            openFifaModal(playerId, pos);
            return;
        }

        // Otherwise activate slot for click-to-select
        activateSlot(container);
    }

    function activateSlot(el) {
        if (activeSlot) activeSlot.querySelector('.slot-circle').classList.remove('border-amber-500', 'border-solid');
        activeSlot = el;
        activeSlot.querySelector('.slot-circle').classList.add('border-amber-500', 'border-solid', 'border-2');
    }

    function selectPlayerCard(el) {
        const id = el.getAttribute('data-player-id');

        if (!activeSlot) return; // No slot selected, drag instead

        const currentPos = activeSlot.getAttribute('data-pos');

        // Remove old player from this slot
        const oldId = assignment[currentPos];
        if (oldId) {
            const oldCard = document.querySelector(`.player-card[data-player-id="${oldId}"]`);
            if (oldCard) oldCard.classList.remove('selected');
        }

        assignment[currentPos] = id;
        fillSlot(activeSlot, playerData[id]);
        markPlayerSelected(id);
        activeSlot = null;
    }

    function fillSlot(container, player) {
        const slotCircle = container.querySelector('.slot-circle');
        slotCircle.classList.add('filled');
        // Drag events for already filled slots
        slotCircle.draggable = true;
        slotCircle.ondragstart = (e) => onDragStartFromSlot(e, slotCircle);
        slotCircle.ondragend = onDragEnd;

        // Check if this player is the active captain
        const activeCaptainId = captains.find(id => Object.values(assignment).includes(id));
        const isCaptain = player.id === activeCaptainId;

        slotCircle.innerHTML = `
            <div class="relative w-full h-full flex items-center justify-center p-1">
                <div class="text-xs font-black text-slate-900">${player.number}</div>
                ${isCaptain ? `
                    <div class="absolute -top-1 -right-1 w-4 h-4 rounded-full gradient-primary border border-white/20 flex items-center justify-center text-[7px] font-black text-white shadow-lg">C</div>
                ` : ''}
            </div>
        `;
        const nameEl = container.querySelector('.slot-name');
        nameEl.innerText = player.name.split(' ')[0];
        nameEl.classList.add('text-primary-500', 'dark:text-primary-400');
    }

    function clearSlot(pos) {
        const container = document.querySelector(`[data-pos="${pos}"]`);
        if (!container) return;

        const playerId = assignment[pos];
        if (playerId) {
            const card = document.querySelector(`.player-card[data-player-id="${playerId}"]`);
            if (card) card.classList.remove('selected');
        }

        delete assignment[pos];
        const slotCircle = container.querySelector('.slot-circle');
        slotCircle.classList.remove('filled');
        slotCircle.draggable = false;
        slotCircle.innerHTML = '';
        container.querySelector('.slot-name').innerText = pos;
        container.querySelector('.slot-name').classList.remove('text-primary-500', 'dark:text-primary-400');

        triggerAutoSave();
    }

    function markPlayerSelected(playerId) {
        const card = document.querySelector(`.player-card[data-player-id="${playerId}"]`);
        if (card) card.classList.add('selected');
    }

    // ============================================================
    // BENCH RENDERING
    // ============================================================
    function renderBench() {
        const benchSlots = document.getElementById('benchSlots');
        benchSlots.innerHTML = '';

        if (substitutes.length === 0) {
            benchSlots.innerHTML = '<div class="bench-placeholder text-white/10 text-xs italic flex items-center justify-center w-full py-4">Glissez des joueurs ici pour les ajouter au banc</div>';
        } else {
            substitutes.forEach(playerId => {
                const p = playerData[playerId];
                if (!p) return;

                const card = document.createElement('div');
                card.className = 'bench-card p-3 rounded-2xl bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 flex items-center gap-3 cursor-grab active:cursor-grabbing hover:border-primary-500/30 transition shadow-sm dark:shadow-none';
                card.setAttribute('draggable', 'true');
                card.setAttribute('data-player-id', playerId);
                card.ondragstart = (e) => onDragStartFromBench(e, card);
                card.ondragend = (e) => { card.classList.remove('dragging'); onDragEnd(e); };
                card.onclick = () => openFifaModal(playerId, null);

                card.innerHTML = `
                    <div class="w-8 h-8 flex flex-col items-center justify-center rounded bg-gradient-to-b from-[#94a3b8] to-[#475569] text-white shadow-lg border-b-2 border-[#1e293b]">
                        <span class="text-xs font-[900] leading-none">${Math.round((p.vit + p.tir + p.pas + p.dri + p.def + p.phy) / 6)}</span>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-900 dark:text-white">${p.name}</p>
                        <p class="text-[8px] text-slate-500 dark:text-white/40 font-bold uppercase">${p.position} #${p.number}</p>
                    </div>
                    <button onclick="event.stopPropagation(); removeFromBench('${playerId}')" class="ml-auto w-6 h-6 rounded-lg hover:bg-red-500/20 text-slate-400 dark:text-white/20 hover:text-red-400 transition flex items-center justify-center">
                        <i class="fa-solid fa-xmark text-xs"></i>
                    </button>
                `;
                benchSlots.appendChild(card);
            });
        }

        document.getElementById('benchCount').textContent = substitutes.length + ' joueur' + (substitutes.length > 1 ? 's' : '');
    }

    function removeFromBench(playerId) {
        substitutes = substitutes.filter(id => id !== playerId);
        const card = document.querySelector(`.player-card[data-player-id="${playerId}"]`);
        if (card) card.classList.remove('selected');
        renderBench();
    }

    // ============================================================
    // FIFA MODAL
    // ============================================================
    function openFifaModal(playerId, slotPos) {
        const p = playerData[playerId];
        if (!p) return;

        currentModalPlayerId = playerId;
        currentModalSlotPos = slotPos;

        const overall = Math.round((p.vit + p.tir + p.pas + p.dri + p.def + p.phy) / 6);

        document.getElementById('fifaOverall').textContent = overall;
        document.getElementById('fifaPosition').textContent = p.position;
        document.getElementById('fifaNumber').textContent = p.number;
        document.getElementById('fifaName').textContent = p.name.toUpperCase();
        document.getElementById('fifaClub').textContent = 'FootLogic Elite';
        document.getElementById('fifaVIT').textContent = p.vit;
        document.getElementById('fifaTIR').textContent = p.tir;
        document.getElementById('fifaPAS').textContent = p.pas;
        document.getElementById('fifaDRI').textContent = p.dri;
        document.getElementById('fifaDEF').textContent = p.def;
        document.getElementById('fifaPHY').textContent = p.phy;

        // Color stats based on value
        document.querySelectorAll('.fifa-stat .text-xl').forEach(el => {
            const val = parseInt(el.textContent);
            if (val >= 80) el.classList.add('text-green-400');
            else if (val >= 60) el.className = el.className.replace('text-white', '') + ' text-amber-400';
            else el.className = el.className.replace('text-white', '') + ' text-red-400';
        });

        const modal = document.getElementById('fifaModal');
        modal.classList.add('show');
        setTimeout(() => {
            document.getElementById('fifaCardInner').style.transform = 'scale(1)';
        }, 10);
    }

    function closeFifaModal(e) {
        if (e && e.target !== e.currentTarget) return;
        const modal = document.getElementById('fifaModal');
        document.getElementById('fifaCardInner').style.transform = 'scale(0)';
        setTimeout(() => modal.classList.remove('show'), 300);
        currentModalPlayerId = null;
        currentModalSlotPos = null;
    }

    function removePlayerFromSlot() {
        if (currentModalSlotPos && assignment[currentModalSlotPos]) {
            clearSlot(currentModalSlotPos);
        } else if (currentModalPlayerId && substitutes.includes(currentModalPlayerId)) {
            removeFromBench(currentModalPlayerId);
        }
        closeFifaModal({ target: document.getElementById('fifaModal'), currentTarget: document.getElementById('fifaModal') });
    }

    // ============================================================
    // SAVE & RESET
    // ============================================================
    function saveTactics() {
        const btn = document.getElementById('saveBtn');
        const formation = document.getElementById('formationSelect').value;

        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;

        fetch('/coach/tactics/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                formation: formation,
                starters: assignment,
                substitutes: substitutes,
                team_id: '{{ selected_team_id }}'
            })
        })
            .then(r => r.json())
            .then(d => {
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                btn.classList.replace('gradient-primary', 'bg-green-500');
                showToast('Tactique sauvegard√©e avec succ√®s !');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i>';
                    btn.classList.replace('bg-green-500', 'gradient-primary');
                    btn.disabled = false;
                }, 2000);
            })
            .catch(() => {
                btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i>';
                btn.classList.replace('gradient-primary', 'bg-red-500');
                showToast('Erreur de sauvegarde');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i>';
                    btn.classList.replace('bg-red-500', 'gradient-primary');
                    btn.disabled = false;
                }, 2000);
            });
    }

    function resetPitch() {
        // Free all starters
        Object.keys(assignment).forEach(pos => {
            const playerId = assignment[pos];
            if (playerId) {
                const card = document.querySelector(`.player-card[data-player-id="${playerId}"]`);
                if (card) card.classList.remove('selected');
            }
        });
        // Free all bench
        substitutes.forEach(playerId => {
            const card = document.querySelector(`.player-card[data-player-id="${playerId}"]`);
            if (card) card.classList.remove('selected');
        });

        assignment = {};
        substitutes = [];
        updateFormation();
        renderBench();
        triggerAutoSave();
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMessage').textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ============================================================
    // TACTICAL CONFIGURATION
    // ============================================================
    const savedTacticalConfig = JSON.parse(configEl.getAttribute('data-tactical-config') || '{}');
    let tacticalConfig = {
        passing: savedTacticalConfig.passing || null,
        space: savedTacticalConfig.space || null,
        defensive: savedTacticalConfig.defensive || null,
        pressing: savedTacticalConfig.pressing || null,
        marking: savedTacticalConfig.marking || null,
        counter_pressing: savedTacticalConfig.counter_pressing || false,
        goalkeeper_distribution: savedTacticalConfig.goalkeeper_distribution || null
    };

    function openTacticalConfig() {
        const modal = document.getElementById('tacticalModal');
        modal.classList.add('show');
        setTimeout(() => {
            document.getElementById('tacticalModalInner').style.transform = 'scale(1)';
        }, 10);
        restoreTacticalUI();
        updatePreview();
    }

    function closeTacticalConfig(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('tacticalModalInner').style.transform = 'scale(0)';
        setTimeout(() => document.getElementById('tacticalModal').classList.remove('show'), 300);
    }

    // ============================================================
    // PHASE 2: TACTIQUE ULTIMATE ANALYTICS FUNCTIONS
    // ============================================================
    function openTacticsAnalytics() {
        const modal = document.getElementById('tacticsAnalyticsModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            document.getElementById('analyticsModalInner').style.transform = 'scale(1)';
        }, 10);
        calculateTacticalMetrics();
        updateAnalyticsTimestamp();
    }

    function closeTacticsAnalytics(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('analyticsModalInner').style.transform = 'scale(0)';
        setTimeout(() => {
            const modal = document.getElementById('tacticsAnalyticsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    function switchAnalyticsTab(tabName, btn) {
        // Hide all content tabs
        document.querySelectorAll('.analytics-content').forEach(tab => {
            tab.classList.add('hidden');
        });

        // Remove active class from all buttons
        document.querySelectorAll('.analytics-tab').forEach(b => {
            b.classList.remove('active');
        });

        // Show selected content tab
        const contentTab = document.getElementById(tabName + 'Tab');
        if (contentTab) {
            contentTab.classList.remove('hidden');
        }

        // Add active class to clicked button
        if (btn) {
            btn.classList.add('active');
        }
    }

    function updateAnalyticsTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('analyticsTimestamp').textContent = timeString;
    }

    // Calculate and update tactical metrics based on current formation
    function calculateTacticalMetrics() {
        const formation = document.getElementById('formationSelect').value;

        // Simulate metric calculations based on formation
        let metrics = {
            defWidth: 85,
            attackDepth: 75,
            compactness: 78,
            balance: 65
        };

        // Adjust based on formation
        if (formation === '5-4-1' || formation === '5-3-2') {
            metrics.defWidth = 95;
            metrics.attackDepth = 55;
            metrics.balance = 40;
        } else if (formation === '3-4-3' || formation === '4-5-1') {
            metrics.defWidth = 75;
            metrics.attackDepth = 85;
            metrics.balance = 80;
        } else if (formation === '4-3-3' || formation === '4-4-2') {
            metrics.defWidth = 85;
            metrics.attackDepth = 72;
            metrics.balance = 65;
        }

        // Update UI
        document.getElementById('metricDefWidth').textContent = metrics.defWidth + '%';
        document.getElementById('metricAttackDepth').textContent = metrics.attackDepth + '%';
        document.getElementById('metricCompactness').textContent = metrics.compactness + '%';
        document.getElementById('metricBalance').textContent = metrics.balance + '%';
    }

    function setTactic(category, value, btn) {
        tacticalConfig[category] = value;
        // Update active state for category buttons
        const parentMap = {
            passing: 'passingStyle', space: 'playSpace', defensive: 'defensiveStyle',
            pressing: 'pressingStyle', marking: 'markingStyle', goalkeeper_distribution: 'gkStyle'
        };
        const container = document.getElementById(parentMap[category]);
        if (container) {
            container.querySelectorAll('.tactic-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        updatePreview();
        updateSummary();
        triggerAutoSave();
    }

    function setCounterPressing(checked) {
        tacticalConfig.counter_pressing = checked;
        document.getElementById('cpToggleBg').classList.toggle('on', checked);
        document.getElementById('cpToggleDot').classList.toggle('on', checked);
        updatePreview();
        updateSummary();
        triggerAutoSave();
    }

    function restoreTacticalUI() {
        // Restore buttons
        const map = {
            passing: 'passingStyle', space: 'playSpace', defensive: 'defensiveStyle',
            pressing: 'pressingStyle', marking: 'markingStyle'
        };
        Object.entries(map).forEach(([key, containerId]) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.querySelectorAll('.tactic-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-value') === tacticalConfig[key]);
            });
        });
        // Restore counter pressing
        const cp = tacticalConfig.counter_pressing;
        document.getElementById('counterPressing').checked = cp;
        document.getElementById('cpToggleBg').classList.toggle('on', cp);
        document.getElementById('cpToggleDot').classList.toggle('on', cp);
        updateSummary();
    }

    // Toggle counter pressing on label click
    document.getElementById('counterPressingToggle').addEventListener('click', function (e) {
        if (e.target.tagName === 'INPUT') return;
        const cb = document.getElementById('counterPressing');
        cb.checked = !cb.checked;
        setCounterPressing(cb.checked);
    });

    function updatePreview() {
        // Space zones
        const zoneL = document.getElementById('pvZoneLeft');
        const zoneR = document.getElementById('pvZoneRight');
        const zoneC = document.getElementById('pvZoneCenter');
        zoneL.setAttribute('fill', 'transparent');
        zoneR.setAttribute('fill', 'transparent');
        zoneC.setAttribute('fill', 'transparent');

        if (tacticalConfig.space === 'couloir_gauche') {
            zoneL.setAttribute('fill', 'rgba(16,185,129,0.1)');
        } else if (tacticalConfig.space === 'couloir_droit') {
            zoneR.setAttribute('fill', 'rgba(16,185,129,0.1)');
        } else if (tacticalConfig.space === 'axe') {
            zoneC.setAttribute('fill', 'rgba(16,185,129,0.1)');
        } else if (tacticalConfig.space === 'deux_couloirs') {
            zoneL.setAttribute('fill', 'rgba(16,185,129,0.1)');
            zoneR.setAttribute('fill', 'rgba(16,185,129,0.1)');
        } else if (tacticalConfig.space === 'mixte') {
            zoneL.setAttribute('fill', 'rgba(16,185,129,0.05)');
            zoneR.setAttribute('fill', 'rgba(16,185,129,0.05)');
            zoneC.setAttribute('fill', 'rgba(16,185,129,0.05)');
        }

        // Defensive line
        const defLine = document.getElementById('pvDefLine');
        const defLabel = document.getElementById('pvDefLabel');
        const defPositions = { bloc_bas: 380, bloc_median: 340, bloc_haut: 290 };
        const defY = defPositions[tacticalConfig.defensive] || 340;
        defLine.setAttribute('y1', defY);
        defLine.setAttribute('y2', defY);
        defLabel.setAttribute('y', defY + 15);
        const defNames = { bloc_bas: 'BLOC BAS', bloc_median: 'BLOC M√âDIAN', bloc_haut: 'BLOC HAUT' };
        defLabel.textContent = defNames[tacticalConfig.defensive] || 'BLOC M√âDIAN';

        // Pressing line
        const pressLine = document.getElementById('pvPressLine');
        const pressLabel = document.getElementById('pvPressLabel');
        const pressPositions = { haut: 100, median: 180, bas: 260, tout_terrain: 140 };
        const pressY = pressPositions[tacticalConfig.pressing] || 180;
        pressLine.setAttribute('y1', pressY);
        pressLine.setAttribute('y2', pressY);
        pressLabel.setAttribute('y', pressY - 10);
        const pressNames = { haut: 'PRESSING HAUT', median: 'PRESSING M√âDIAN', bas: 'PRESSING BAS', tout_terrain: 'PRESSING TOTAL' };
        pressLabel.textContent = pressNames[tacticalConfig.pressing] || 'PRESSING';

        if (tacticalConfig.pressing === 'tout_terrain') {
            pressLine.setAttribute('stroke-dasharray', '4,2');
            pressLine.setAttribute('stroke', 'rgba(239,68,68,0.7)');
        } else {
            pressLine.setAttribute('stroke-dasharray', '8,4');
            pressLine.setAttribute('stroke', 'rgba(239,68,68,0.5)');
        }

        // Passing arrows
        const passG = document.getElementById('pvPassArrows');
        passG.innerHTML = '';
        const passColor = 'rgba(168,85,247,0.4)';
        if (tacticalConfig.passing === 'courte') {
            for (let i = 0; i < 3; i++) {
                const x = 100 + i * 50;
                passG.innerHTML += `<line x1="${x}" y1="280" x2="${x}" y2="250" stroke="${passColor}" stroke-width="1.5" marker-end="url(#arrowPurple)"/>`;
            }
        } else if (tacticalConfig.passing === 'long') {
            passG.innerHTML += `<line x1="150" y1="350" x2="150" y2="120" stroke="${passColor}" stroke-width="2" stroke-dasharray="6,3"/>`;
        } else if (tacticalConfig.passing === 'direct') {
            passG.innerHTML += `<line x1="150" y1="300" x2="150" y2="150" stroke="${passColor}" stroke-width="2.5"/>`;
        }

        // Counter pressing
        const cpGroup = document.getElementById('pvCounterPress');
        cpGroup.setAttribute('opacity', tacticalConfig.counter_pressing ? '1' : '0');

        // Marking
        const markG = document.getElementById('pvMarking');
        markG.innerHTML = '';
        if (tacticalConfig.marking === 'individuel') {
            const positions = [[80, 320], [150, 310], [220, 320], [120, 340], [180, 340]];
            positions.forEach(([x, y]) => {
                markG.innerHTML += `<circle cx="${x}" cy="${y}" r="6" fill="none" stroke="rgba(139,92,246,0.4)" stroke-width="1" stroke-dasharray="3,2"/>`;
                markG.innerHTML += `<circle cx="${x}" cy="${y}" r="2" fill="rgba(139,92,246,0.5)"/>`;
            });
        } else if (tacticalConfig.marking === 'zone') {
            markG.innerHTML += `<rect x="40" y="300" width="70" height="50" rx="4" fill="rgba(139,92,246,0.06)" stroke="rgba(139,92,246,0.2)" stroke-width="1"/>`;
            markG.innerHTML += `<rect x="115" y="300" width="70" height="50" rx="4" fill="rgba(139,92,246,0.06)" stroke="rgba(139,92,246,0.2)" stroke-width="1"/>`;
            markG.innerHTML += `<rect x="190" y="300" width="70" height="50" rx="4" fill="rgba(139,92,246,0.06)" stroke="rgba(139,92,246,0.2)" stroke-width="1"/>`;
        }
    }

    function updateSummary() {
        const summary = document.getElementById('configSummary');
        const labels = {
            passing: { label: 'Passes', courte: 'Courtes', direct: 'Directes', long: 'Longues', mixte: 'Mixtes' },
            space: { label: 'Espace', couloir_gauche: 'Couloir G', couloir_droit: 'Couloir D', axe: 'Axe', deux_couloirs: '2 Couloirs', mixte: 'Mixte' },
            defensive: { label: 'D√©fense', bloc_bas: 'Bloc bas', bloc_median: 'Bloc m√©dian', bloc_haut: 'Bloc haut' },
            pressing: { label: 'Pressing', haut: 'Haut', median: 'M√©dian', bas: 'Bas', tout_terrain: 'Total' },
            marking: { label: 'Marquage', individuel: 'Individuel', zone: 'En zone' },
            goalkeeper_distribution: { label: 'Relance', courte: 'Courte', longue: 'Longue', rapide: 'Rapide' }
        };

        Object.entries(labels).forEach(([key, data]) => {
            const val = tacticalConfig[key];
            if (val) {
                hasConfig = true;
                html += `<div class="summary-item flex items-center justify-between border-b border-slate-200 dark:border-white/5 pb-2">
                            <span class="text-[10px] text-slate-400 dark:text-white/30 font-bold uppercase tracking-widest">${data.label}</span>
                            <span class="text-[10px] text-amber-500 dark:text-amber-400 font-extrabold uppercase tracking-tight">${data[val] || val}</span>
                         </div>`;
            }
        });
        if (tacticalConfig.counter_pressing) {
            hasConfig = true;
            html += `<div class="summary-item flex items-center justify-between border-b border-slate-200 dark:border-white/5 pb-2">
                        <span class="text-[10px] text-slate-400 dark:text-white/30 font-bold uppercase tracking-widest">Transition</span>
                        <span class="text-[10px] text-amber-500 dark:text-amber-400 font-extrabold uppercase tracking-tight">CONTRE-PRESSING</span>
                     </div>`;
        }
        summary.innerHTML = hasConfig ? html : '<div class="flex items-center justify-center py-4"><p class="text-[10px] text-slate-300 dark:text-white/20 italic">Configuration vierge...</p></div>';
    }

    function resetTacticalConfig() {
        tacticalConfig = { passing: null, space: null, defensive: null, pressing: null, marking: null, counter_pressing: false };
        restoreTacticalUI();
        updatePreview();
        updateSummary();
        triggerAutoSave();
    }

    function saveTacticalConfig() {
        const btn = document.getElementById('saveTacConfigBtn');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Sauvegarde...';
        btn.disabled = true;

        fetch('/coach/tactics/save-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                config: tacticalConfig,
                team_id: '{{ selected_team_id }}'
            })
        })
            .then(r => r.json())
            .then(() => {
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Valid√© !';
                showToast('Plan de jeu sauvegard√© !');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Valider le Plan';
                    btn.disabled = false;
                    closeTacticalConfig({ target: document.getElementById('tacticalModal'), currentTarget: document.getElementById('tacticalModal') });
                }, 1500);
            })
            .catch(() => {
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Valider le Plan';
                btn.disabled = false;
                showToast('Erreur de sauvegarde');
            });
    }

    // ============================================================
    // INIT
    // ============================================================
    document.getElementById('benchArea').addEventListener('dragleave', onDragLeaveBench);
    updateFormation();
    renderBench();
    // ============================================================
    // PRESETS LOGIC
    // ============================================================
    function openSavePresetModal() {
        const modal = document.getElementById('savePresetModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            document.getElementById('savePresetModalInner').style.transform = 'scale(1)';
        }, 10);
    }

    function closeSavePresetModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('savePresetModalInner').style.transform = 'scale(0)';
        setTimeout(() => {
            const modal = document.getElementById('savePresetModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    function submitSavePreset() {
        const name = document.getElementById('presetName').value;
        const desc = document.getElementById('presetDesc').value;
        const btn = document.getElementById('btnSavePreset');

        if (!name) {
            alert("Veuillez donner un nom √† la tactique");
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

        const formation = document.getElementById('formationSelect').value;

        fetch('/coach/tactics/preset/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                team_id: '{{ selected_team_id }}',
                name: name,
                description: desc,
                formation: formation,
                starters: assignment,
                substitutes: substitutes,
                instructions: tacticalConfig
            })
        })
            .then(r => r.json())
            .then(d => {
                closeSavePresetModal({ target: document.getElementById('savePresetModal'), currentTarget: document.getElementById('savePresetModal') });
                showToast('Tactique enregistr√©e !');
                btn.disabled = false;
                btn.innerText = 'ENREGISTRER';
                document.getElementById('presetName').value = '';
            })
            .catch(e => {
                console.error(e);
                alert('Erreur lors de la sauvegarde');
                btn.disabled = false;
                btn.innerText = 'ENREGISTRER';
            });
    }

    function openLoadPresetModal() {
        const modal = document.getElementById('loadPresetModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            document.getElementById('loadPresetModalInner').style.transform = 'scale(1)';
        }, 10);
        loadPresets();
    }

    function closeLoadPresetModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('loadPresetModalInner').style.transform = 'scale(0)';
        setTimeout(() => {
            const modal = document.getElementById('loadPresetModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    function loadPresets() {
        const list = document.getElementById('presetList');
        list.innerHTML = '<div class="col-span-full text-center py-16"><div class="inline-block"><i class="fa-solid fa-spinner fa-spin text-amber-400 text-4xl mb-4 block"></i><p class="text-white/40 text-sm font-bold">Chargement...</p></div></div>';

        fetch(`/coach/tactics/presets?team_id={{ selected_team_id }}`)
            .then(r => r.json())
            .then(data => {
                // PHASE 3: Limiter √† 5 presets max
                const maxPresets = data.slice(0, 5);

                if (maxPresets.length === 0) {
                    list.innerHTML = `
                        <div class="col-span-full text-center py-16">
                            <div class="inline-block">
                                <i class="fa-solid fa-folder-open text-white/20 text-5xl mb-4 block"></i>
                                <p class="text-white/40 text-sm font-bold uppercase tracking-wider">Aucune tactique sauvegard√©e</p>
                                <p class="text-white/20 text-xs mt-2">Cr√©ez une nouvelle tactique et sauvegardez-la pour la r√©utiliser</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('presetCount').textContent = '0';
                    return;
                }

                list.innerHTML = '';
                maxPresets.forEach((preset, index) => {
                    const el = document.createElement('div');
                    el.className = 'tactique-card relative z-10';
                    el.setAttribute('data-preset-id', preset._id);

                    // Formation color
                    const formations = {
                        '4-3-3': 'from-blue-400 to-blue-600',
                        '4-4-2': 'from-emerald-400 to-emerald-600',
                        '3-5-2': 'from-purple-400 to-purple-600',
                        '4-2-3-1': 'from-orange-400 to-orange-600',
                        '5-3-2': 'from-red-400 to-red-600',
                        '4-1-2-1-2': 'from-pink-400 to-pink-600',
                        '4-3-2-1': 'from-cyan-400 to-cyan-600',
                        '3-4-3': 'from-indigo-400 to-indigo-600',
                        '4-5-1': 'from-teal-400 to-teal-600',
                        '5-4-1': 'from-violet-400 to-violet-600'
                    };
                    const formationColor = formations[preset.formation] || 'from-amber-400 to-amber-600';

                    el.innerHTML = `
                        <div>
                            <!-- Name and Formation -->
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <h4 class="font-[900] text-white text-lg uppercase tracking-tighter">${preset.name}</h4>
                                    <p class="text-[11px] text-white/50 font-bold uppercase tracking-widest mt-1">
                                        <i class="fa-solid fa-shield text-white/30 mr-1"></i>Sauvegard√©e
                                    </p>
                                </div>
                                <span class="formation-badge">${preset.formation}</span>
                            </div>

                            <!-- Description if available -->
                            ${preset.description ? `<p class="text-xs text-white/60">${preset.description}</p>` : ''}

                            <!-- Actions -->
                            <div class="flex items-center gap-3 mt-4">
                                <button onclick="applyPresetWithAnimation('${preset._id}')"
                                    class="tactique-load-btn tactique-action-btn relative overflow-hidden group">
                                    <i class="fa-solid fa-play group-hover:translate-x-1 transition-transform mr-2"></i>
                                    <span>Charger</span>
                                </button>
                                <button onclick="deletePresetCard('${preset._id}', this)"
                                    class="tactique-delete-btn tactique-action-btn hover:scale-110 transition-transform"
                                    title="Supprimer">
                                    <i class="fa-solid fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                });

                // Update count
                document.getElementById('presetCount').textContent = maxPresets.length;
            })
            .catch(() => {
                list.innerHTML = '<div class="col-span-full text-center py-10 text-red-400">Erreur de chargement</div>';
            });
    }

    // PHASE 3: Apply preset with animation
    function applyPresetWithAnimation(presetId) {
        const card = document.querySelector(`[data-preset-id="${presetId}"]`);
        if (!card) return;

        // Add loading state
        card.classList.add('loading');

        if (!confirm('Charger cette tactique remplacera la configuration actuelle. Continuer ?')) {
            card.classList.remove('loading');
            return;
        }

        applyPreset(presetId, card);
    }

    // PHASE 3: Delete with confirmation
    function deletePresetCard(presetId, btn) {
        if (!confirm('Supprimer cette tactique ? (Cette action est irr√©versible)')) return;
        deletePreset(presetId, btn);
    }

    function applyPreset(presetId, card) {
        fetch('/coach/tactics/preset/load', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                team_id: '{{ selected_team_id }}',
                preset_id: presetId
            })
        })
            .then(r => r.json())
            .then(d => {
                // Add success animation if card element provided
                if (card) {
                    card.classList.remove('loading');
                    card.classList.add('success');

                    // Show success message
                    const originalBtn = card.querySelector('.tactique-load-btn');
                    if (originalBtn) {
                        const originalHTML = originalBtn.innerHTML;
                        originalBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Charg√©e!';
                        originalBtn.style.opacity = '0.7';
                    }

                    // Reload after animation
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    location.reload();
                }
            })
            .catch(err => {
                if (card) card.classList.remove('loading');
                alert('Erreur lors du chargement de la tactique');
            });
    }

    function deletePreset(presetId, btn) {
        const card = document.querySelector(`[data-preset-id="${presetId}"]`);
        if (!card) return;

        // Add fade-out animation
        card.style.animation = 'fadeOut 0.3s ease forwards';

        fetch(`/coach/tactics/preset/${presetId}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(() => {
                // Remove card after animation
                setTimeout(() => {
                    card.remove();

                    // Update count
                    const count = document.querySelectorAll('.tactique-card').length;
                    document.getElementById('presetCount').textContent = count;

                    // Show empty state if no presets left
                    if (count === 0) {
                        const list = document.getElementById('presetList');
                        list.innerHTML = `
                            <div class="col-span-full text-center py-16">
                                <div class="inline-block">
                                    <i class="fa-solid fa-folder-open text-white/20 text-5xl mb-4 block"></i>
                                    <p class="text-white/40 text-sm font-bold uppercase tracking-wider">Aucune tactique sauvegard√©e</p>
                                </div>
                            </div>
                        `;
                    }
                }, 300);
            })
            .catch(() => {
                card.style.animation = 'none'; // Reset animation if error
                alert('Erreur lors de la suppression');
            });
    }

    // ============================================================
    // PHASE 4: VISUALISEUR TACTIQUE FUNCTIONS
    // ============================================================
    let currentVisualiserTab = 'pitch';
    let currentPhase = 'defense';

    function openVisualiser() {
        const modal = document.getElementById('visualiserModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            document.getElementById('visualiserModalInner').style.transform = 'scale(1)';
        }, 10);
        renderPlayerPositions();
    }

    function closeVisualiser(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('visualiserModalInner').style.transform = 'scale(0)';
        setTimeout(() => {
            const modal = document.getElementById('visualiserModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    function switchVisualiserTab(tabName, btn) {
        // Hide all content tabs
        document.querySelectorAll('.visualiser-content').forEach(tab => {
            tab.classList.add('hidden');
        });

        // Remove active class from all buttons
        document.querySelectorAll('.visualiser-tab').forEach(b => {
            b.classList.remove('active');
        });

        // Show selected content tab
        const contentTab = document.getElementById(tabName + 'Tab');
        if (contentTab) {
            contentTab.classList.remove('hidden');
        }

        // Add active class to clicked button
        if (btn) {
            btn.classList.add('active');
        }

        currentVisualiserTab = tabName;

        // Render content based on tab
        if (tabName === 'pitch') {
            renderPlayerPositions();
        } else if (tabName === 'coverage') {
            renderCoverageZones();
        } else if (tabName === 'passing') {
            renderPassingLines();
        } else if (tabName === 'phases') {
            renderPhase(currentPhase);
        }
    }

    function switchPhase(phaseName) {
        currentPhase = phaseName;

        // Update phase buttons
        document.querySelectorAll('.phase-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-phase') === phaseName);
        });

        // Update title
        const phaseNames = {
            defense: 'Phase D√©fensive',
            transition: 'Phase Transition',
            attack: 'Phase Attaque'
        };
        document.getElementById('phaseTitle').textContent = phaseNames[phaseName] || 'Phase Tactique';

        renderPhase(phaseName);
    }

    function renderPlayerPositions() {
        const g = document.getElementById('playerPositions');
        g.innerHTML = '';

        // Get current positions from assignment
        const formation = formations[document.getElementById('formationSelect').value] || formations['4-3-3'];
        let posIndex = 0;

        Object.entries(formation).forEach(([pos, [x, y]]) => {
            // Create circle for player
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '1.8');
            circle.setAttribute('fill', '#10b981');
            circle.setAttribute('opacity', '0.8');
            circle.setAttribute('stroke', '#ffffff');
            circle.setAttribute('stroke-width', '0.2');

            // Add number
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            text.setAttribute('y', y);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('dominant-baseline', 'middle');
            text.setAttribute('font-size', '1.2');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', 'white');
            text.setAttribute('pointer-events', 'none');
            text.textContent = pos.substring(0, 2).toUpperCase();

            g.appendChild(circle);
            g.appendChild(text);

            posIndex++;
        });
    }

    function renderCoverageZones() {
        const g = document.getElementById('coverageZones');
        g.innerHTML = '';

        // Draw coverage zones (defensive, midfield, attacking thirds)
        const zones = [
            { x: 0, y: 0, width: 35, height: 68, color: '#3b82f6', label: 'D√âFENSE' },
            { x: 35, y: 0, width: 35, height: 68, color: '#a855f7', label: 'MILIEU' },
            { x: 70, y: 0, width: 35, height: 68, color: '#ef4444', label: 'ATTAQUE' }
        ];

        zones.forEach(zone => {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', zone.x);
            rect.setAttribute('y', zone.y);
            rect.setAttribute('width', zone.width);
            rect.setAttribute('height', zone.height);
            rect.setAttribute('fill', zone.color);
            rect.setAttribute('opacity', '0.2');

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', zone.x + zone.width / 2);
            text.setAttribute('y', zone.y + zone.height / 2);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('dominant-baseline', 'middle');
            text.setAttribute('font-size', '2');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', zone.color);
            text.setAttribute('opacity', '0.6');
            text.textContent = zone.label;

            g.appendChild(rect);
            g.appendChild(text);
        });
    }

    function renderPassingLines() {
        const g = document.getElementById('passingLines');
        g.innerHTML = '';

        const formation = formations[document.getElementById('formationSelect').value] || formations['4-3-3'];
        const positions = Object.entries(formation).map(([pos, coords]) => ({ pos, x: coords[0], y: coords[1] }));

        // Draw lines between adjacent players (simple passing triangles)
        positions.forEach((player, i) => {
            // Connect to next 2 players in same line
            for (let j = i + 1; j < Math.min(i + 3, positions.length); j++) {
                const distance = Math.sqrt(Math.pow(positions[j].x - player.x, 2) + Math.pow(positions[j].y - player.y, 2));
                if (distance < 35) { // Only draw if players are close enough
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', player.x);
                    line.setAttribute('y1', player.y);
                    line.setAttribute('x2', positions[j].x);
                    line.setAttribute('y2', positions[j].y);
                    line.setAttribute('stroke', '#fbbf24');
                    line.setAttribute('stroke-width', '0.3');
                    line.setAttribute('stroke-dasharray', '1,1');
                    g.appendChild(line);
                }
            }
        });
    }

    function renderPhase(phase) {
        const g = document.getElementById('phaseContent');
        g.innerHTML = '';

        const formation = formations[document.getElementById('formationSelect').value] || formations['4-3-3'];
        const positions = Object.entries(formation);

        if (phase === 'defense') {
            // Draw defensive line (lower on pitch)
            positions.forEach(([pos, [x, y]]) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y > 50 ? y : 50); // Move down for defensive
                circle.setAttribute('r', '1.8');
                circle.setAttribute('fill', '#3b82f6');
                circle.setAttribute('opacity', '0.7');
                g.appendChild(circle);
            });
            document.getElementById('defenseInfo').textContent = 'Bloc Median';
            document.getElementById('pressingInfo').textContent = 'Bas';
            document.getElementById('attackInfo').textContent = 'Profonde';

        } else if (phase === 'transition') {
            // Show balanced positioning
            positions.forEach(([pos, [x, y]]) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', '1.8');
                circle.setAttribute('fill', '#a855f7');
                circle.setAttribute('opacity', '0.7');
                g.appendChild(circle);
            });
            document.getElementById('defenseInfo').textContent = 'Bloc Median';
            document.getElementById('pressingInfo').textContent = 'Median';
            document.getElementById('attackInfo').textContent = '√âquilibr√©';

        } else if (phase === 'attack') {
            // Draw attacking formation (higher on pitch)
            positions.forEach(([pos, [x, y]]) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y < 40 ? y : 40); // Move up for attacking
                circle.setAttribute('r', '1.8');
                circle.setAttribute('fill', '#ef4444');
                circle.setAttribute('opacity', '0.7');
                g.appendChild(circle);
            });
            document.getElementById('defenseInfo').textContent = 'Bloc Haut';
            document.getElementById('pressingInfo').textContent = 'Haut';
            document.getElementById('attackInfo').textContent = 'Avanc√©';
        }
    }

    function playVisualisationAnimation() {
        // Simple animation: cycle through phases
        const phases = ['defense', 'transition', 'attack'];
        let idx = phases.indexOf(currentPhase);
        idx = (idx + 1) % phases.length;
        switchPhase(phases[idx]);
    }

    // ============================================================
    // TACTICAL GUIDE LOGIC
    // ============================================================
    let guideStep = 0;
    const guideSteps = [
        {
            title: "L'Effectif",
            text: "C'est ici que se trouve votre vivier de joueurs. Glissez-les directement sur le terrain pour les assigner √† un poste ou vers le banc pour pr√©parer vos rempla√ßants.",
            element: "tactics-config > .lg\\:w-96", // Sidebar
            position: "right"
        },
        {
            title: "Le Terrain Tactique",
            text: "Visualisez votre formation en temps r√©el. Cliquez sur un poste vide pour assigner un joueur, ou sur un joueur d√©j√† plac√© pour voir ses statistiques d√©taill√©es.",
            element: "pitchArea",
            position: "bottom"
        },
        {
            title: "Capitaines & Tireurs",
            text: "D√©signez vos leaders et vos sp√©cialistes des coups de pied arr√™t√©s. Ces choix sont cruciaux pour la r√©ussite de votre strat√©gie.",
            selector: ".absolute.top-10.right-10 .flex.flex-col.gap-2.p-2", // The button container
            position: "left"
        },
        {
            title: "Configuration Avanc√©e",
            text: "Utilisez l'ic√¥ne d'√©checs pour ajuster votre style de jeu : largeur, pressing, marquage et plus encore. Chaque choix influence le comportement de votre √©quipe.",
            selector: ".absolute.top-10.right-10 button[title='Configuration Tactique']",
            position: "left"
        },
        {
            title: "Sauvegarde Automatique",
            text: "Ne craignez plus de perdre vos modifications. Chaque changement est automatiquement enregistr√©. Le statut de sauvegarde s'affiche ici.",
            selector: "#autoSaveStatus",
            position: "top"
        }
    ];

    function startTacticalGuide() {
        guideStep = 0;
        const overlay = document.getElementById('guideOverlay');
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.add('active'), 10);
        showGuideStep();
    }

    function nextGuideStep() {
        guideStep++;
        if (guideStep >= guideSteps.length) {
            closeGuide();
        } else {
            showGuideStep();
        }
    }

    function closeGuide() {
        const overlay = document.getElementById('guideOverlay');
        overlay.classList.remove('active');
        document.querySelectorAll('.guide-focus').forEach(el => el.classList.remove('guide-focus'));
        setTimeout(() => overlay.classList.add('hidden'), 500);
    }

    function showGuideStep() {
        const step = guideSteps[guideStep];
        const card = document.getElementById('guideCard');
        const overlay = document.getElementById('guideOverlay');

        // Reset previous focus
        document.querySelectorAll('.guide-focus').forEach(el => el.classList.remove('guide-focus'));

        // Update content
        document.getElementById('guideStepNumber').innerText = guideStep + 1;
        document.getElementById('guideTitle').innerText = step.title;
        document.getElementById('guideText').innerText = step.text;
        document.getElementById('guideNextBtn').innerText = guideStep === guideSteps.length - 1 ? "Terminer" : "Suivant";

        // Find element to focus
        let target = null;
        if (step.selector) {
            target = document.querySelector(step.selector);
        } else if (step.element) {
            // Handle complex selectors or IDs
            if (step.element.includes('>')) {
                const parts = step.element.split(' > ');
                let parent = document.getElementById(parts[0]);
                if (parent) target = parent.querySelector(parts[1]);
            } else {
                target = document.getElementById(step.element);
            }
        }

        if (target) {
            target.classList.add('guide-focus');
            const rect = target.getBoundingClientRect();

            card.classList.remove('active');

            setTimeout(() => {
                let top, left;
                const margin = 20;

                if (step.position === "right") {
                    top = rect.top;
                    left = rect.right + margin;
                } else if (step.position === "left") {
                    top = rect.top;
                    left = rect.left - card.offsetWidth - margin;
                } else if (step.position === "top") {
                    top = rect.top - card.offsetHeight - margin;
                    left = rect.left + (rect.width / 2) - (card.offsetWidth / 2);
                } else { // bottom
                    top = rect.bottom + margin;
                    left = rect.left + (rect.width / 2) - (card.offsetWidth / 2);
                }

                // Boundary checks
                left = Math.max(margin, Math.min(left, window.innerWidth - card.offsetWidth - margin));
                top = Math.max(margin, Math.min(top, window.innerHeight - card.offsetHeight - margin));

                card.style.top = `${top}px`;
                card.style.left = `${left}px`;
                card.classList.add('active');
            }, 100);
        }
    }
</script>
{% endblock %}